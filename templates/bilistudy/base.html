<!DOCTYPE html>
<html lang="zh-CN" data-theme="{% if user.is_authenticated and user_preference.theme_preference %}{{ user_preference.theme_preference }}{% else %}light{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}B站学习工具{% endblock %}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- 深色主题CSS -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'bilistudy/css/dark-theme.css' %}">
    <!-- 自定义CSS -->
    <style>
        :root {
            --primary-color: #5B8FF9;
            --primary-light: #EBF2FF;
            --secondary-color: #F6BD16;
            --dark-color: #2C3E50;
            --light-color: #F8F9FA;
            --accent-color: #5AD8A6;
            --text-color: #4A4A4A;
            --text-light: #8C8C8C;
            --border-color: #E8E8E8;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }
        
        html, body {
            height: 100%;
        }

        body {
            background-color: #FAFAFA;
            font-family: 'Noto Sans SC', sans-serif;
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
        }
        
        .navbar {
            background: #FFFFFF;
            box-shadow: 0 2px 10px var(--shadow-color);
            padding: 0.7rem 1rem;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
            font-size: 1.4rem;
        }

        /* 新手指南按钮样式 */
        .beginner-guide-btn {
            border-color: var(--primary-color) !important;
            color: var(--primary-color) !important;
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
            transition: all 0.3s ease;
            animation: pulse-hint 2s infinite;
        }

        .beginner-guide-btn:hover {
            background-color: var(--primary-color) !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        /* 新用户提示动画 */
        @keyframes pulse-hint {
            0%, 70%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            35% {
                transform: scale(1.05);
                box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
            }
        }

        /* 老用户不显示动画 */
        .beginner-guide-btn.no-pulse {
            animation: none !important;
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .beginner-guide-btn {
                font-size: 0.8rem;
                padding: 0.25rem 0.5rem;
                margin-left: 0.5rem !important;
            }

            .beginner-guide-btn .fas {
                display: none; /* 移动端隐藏图标 */
            }
        }

        @media (max-width: 576px) {
            .beginner-guide-btn {
                display: none; /* 超小屏幕隐藏按钮，通过菜单访问 */
            }
        }
        
        .nav-link {
            color: var(--text-color) !important;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover, .nav-link:focus {
            color: var(--primary-color) !important;
            background-color: var(--primary-light);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(91, 143, 249, 0.2);
        }
        
        .btn-primary:hover {
            background-color: #4A7DE0;
            border-color: #4A7DE0;
            box-shadow: 0 4px 8px rgba(91, 143, 249, 0.3);
        }
        
        .btn-bili {
            background: linear-gradient(135deg, var(--primary-color), #7EB2FF);
            border: none;
            color: white;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(91, 143, 249, 0.2);
        }
        
        .btn-bili:hover {
            background: linear-gradient(135deg, #4A7DE0, var(--primary-color));
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(91, 143, 249, 0.3);
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
        }
        
        .card-title {
            color: var(--dark-color);
            font-weight: 600;
        }
        
        .video-item {
            cursor: pointer;
            transition: all 0.2s ease;
            border: none !important;
            margin-bottom: 0.5rem;
            border-radius: 8px !important;
        }
        
        .video-item:hover {
            background-color: var(--light-color);
        }
        
        .video-item.active {
            border-left: 4px solid var(--primary-color) !important;
            background-color: var(--primary-light);
        }
        
        .progress {
            height: 8px;
            border-radius: 4px;
            background-color: var(--border-color);
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(to right, var(--primary-color), #7EB2FF);
        }
        
        main {
            flex: 1;
            padding-bottom: 2rem;
        }

        footer {
            background-color: white;
            color: var(--text-light);
            padding: 2rem 0;
            margin-top: auto;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .pagination .page-link {
            color: var(--primary-color);
        }
        
        /* 自定义复选框样式 */
        .custom-checkbox .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        /* 搜索框样式 */
        .search-container {
            background: linear-gradient(135deg, #F5F7FA, #F8F9FA);
            padding: 1.5rem 0;
            margin-bottom: 0.5rem;
            border-radius: 0 0 30% 30% / 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-box {
            background-color: white;
            border-radius: 100px;
            padding: 0.5rem;
            box-shadow: 0 5px 20px var(--shadow-color);
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .search-box:focus-within {
            box-shadow: 0 5px 25px rgba(91, 143, 249, 0.25);
        }
        
        .search-input {
            border: none;
            box-shadow: none !important;
            padding-left: 1.5rem;
            flex: 1;
            background-color: transparent;
        }
        
        .search-input:focus {
            box-shadow: none;
            outline: none;
            border: none;
        }
        
        .search-btn {
            border-radius: 100px;
            min-width: 100px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
        }
        
        .search-btn i {
            font-size: 1rem;
        }
        
        /* 功能卡片样式 */
        .feature-card {
            text-align: center;
            padding: 2rem;
            height: 100%;
            transition: all 0.3s ease;
            background-color: white;
        }
        
        .feature-card:hover {
            transform: translateY(-10px);
        }
        
        .feature-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 2rem;
            color: white;
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .icon-courses {
            background: linear-gradient(135deg, var(--accent-color), #7EEFC6);
        }
        
        .icon-plan {
            background: linear-gradient(135deg, var(--primary-color), #7EB2FF);
        }
        
        .icon-ai {
            background: linear-gradient(135deg, var(--secondary-color), #FFD666);
        }
        
        /* 视频详情页样式 */
        .video-cover {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .video-info {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .video-meta {
            display: flex;
            align-items: center;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }
        
        .video-meta i {
            width: 20px;
            margin-right: 0.5rem;
            color: var(--primary-color);
        }
        
        /* 美化滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #ccc;
        }
        
        /* 标签样式 */
        .badge {
            font-weight: 500;
            padding: 0.35em 0.65em;
        }
        
        .badge-light {
            background-color: var(--light-color);
            color: var(--text-light);
        }
        
        /* 提示框样式 */
        .alert {
            border-radius: 8px;
            border: none;
            box-shadow: 0 2px 10px var(--shadow-color);
        }
        
        /* 动画效果 */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 用户头像样式 */
        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary-color), #7EB2FF);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        /* 认证模态框样式 */
        .auth-modal .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .auth-modal .modal-header {
            border-bottom: 1px solid #e9ecef;
            padding: 1.5rem;
        }

        .auth-modal .modal-body {
            padding: 1.5rem;
        }

        .auth-modal .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(91, 143, 249, 0.25);
        }

        .auth-modal .input-group .btn {
            border-left: none;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="{% url 'index' %}">
                <i class="fas fa-graduation-cap me-2"></i>B站学习助手
            </a>

            <!-- 新手指南按钮 -->
            {% if user.is_authenticated %}
                {% if not user.preference.has_viewed_guide %}
                    <!-- 新用户显示闪烁动画 -->
                    <a href="{% url 'beginner_guide' %}" class="btn btn-outline-primary btn-sm ms-3 beginner-guide-btn">
                        <i class="fas fa-question-circle me-1"></i>新手指南
                    </a>
                {% else %}
                    <!-- 老用户不显示动画 -->
                    <a href="{% url 'beginner_guide' %}" class="btn btn-outline-primary btn-sm ms-3 beginner-guide-btn no-pulse">
                        <i class="fas fa-question-circle me-1"></i>新手指南
                    </a>
                {% endif %}
            {% else %}
                <!-- 未登录用户不显示动画 -->
                <a href="{% url 'beginner_guide' %}" class="btn btn-outline-primary btn-sm ms-3 beginner-guide-btn no-pulse">
                    <i class="fas fa-question-circle me-1"></i>新手指南
                </a>
            {% endif %}

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'index' %}">
                            <i class="fas fa-home me-1"></i> 首页
                        </a>
                    </li>
                    <li class="nav-item d-sm-none">
                        <a class="nav-link" href="{% url 'beginner_guide' %}">
                            <i class="fas fa-question-circle me-1"></i> 新手指南
                        </a>
                    </li>
                    {% if user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'course_list' %}">
                            <i class="fas fa-list-check me-1"></i> 我的课程
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'study_plans' %}">
                            <i class="fas fa-calendar-alt me-1"></i> 我的计划
                        </a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'ai_assistant' %}">
                            <i class="fas fa-robot me-1"></i> AI助手
                        </a>
                    </li>
                    {% if user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="user-avatar me-2">
                                <i class="fas fa-user"></i>
                            </div>
                            {{ user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><h6 class="dropdown-header">
                                <i class="fas fa-user me-1"></i>
                                {{ user.username }}
                            </h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'account_settings' %}">
                                <i class="fas fa-cog me-2"></i>账户设置
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'logout_user' %}">
                                <i class="fas fa-sign-out-alt me-2"></i>退出登录
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <button class="theme-toggle nav-link border-0 bg-transparent" onclick="toggleTheme()" title="切换主题">
                            <i class="fas fa-sun icon sun-icon"></i>
                            <i class="fas fa-moon icon moon-icon"></i>
                        </button>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <button class="btn btn-outline-primary me-2" onclick="showLoginModal()">
                            <i class="fas fa-sign-in-alt me-1"></i>登录
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-primary me-2" onclick="showRegisterModal()">
                            <i class="fas fa-user-plus me-1"></i>注册
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="theme-toggle nav-link border-0 bg-transparent" onclick="toggleTheme()" title="切换主题">
                            <i class="fas fa-sun icon sun-icon"></i>
                            <i class="fas fa-moon icon moon-icon"></i>
                        </button>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <main class="container py-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
        
        {% block content %}{% endblock %}
    </main>

    <!-- 页脚 -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="mb-3">B站学习助手</h5>
                    <p class="mb-0">一个帮助你更好地利用B站学习资源的工具</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">&copy; 2025 B站学习助手 | 本网站仅用于学习和研究</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- 认证模态框 -->
    {% if not user.is_authenticated %}
    {% include 'bilistudy/auth_modals.html' %}
    {% endif %}

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- 自定义JS -->
    <script>
        // 动画效果
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.animate-fade-in').forEach(function(element, index) {
                setTimeout(function() {
                    element.style.opacity = '1';
                }, 100 * index);
            });
            
            // 清除页面上的HTML标签
            cleanupHtmlTags();
        });
        
        // 清除页面上的HTML标签，特别是标题中的em标签
        function cleanupHtmlTags() {
            // 查找所有包含文本的元素
            const textElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, a, div, title');
            
            textElements.forEach(element => {
                // 如果元素包含HTML标签，将其替换为纯文本
                if (element.innerHTML.includes('<em class="keyword">')) {
                    let content = element.innerHTML;
                    // 替换所有<em class="keyword">标签
                    content = content.replace(/<em class="keyword">|<\/em>/g, '');
                    element.innerHTML = content;
                }
            });
            
            // 特别处理document.title
            if (document.title.includes('<em class="keyword">')) {
                document.title = document.title.replace(/<em class="keyword">|<\/em>/g, '');
            }
        }

        // 认证模态框函数
        function showLoginModal() {
            $('#registerModal').modal('hide');
            $('#forgotPasswordModal').modal('hide');
            $('#loginModal').modal('show');
        }

        function showRegisterModal() {
            $('#loginModal').modal('hide');
            $('#forgotPasswordModal').modal('hide');
            $('#registerModal').modal('show');
        }

        function showForgotPasswordModal() {
            $('#loginModal').modal('hide');
            $('#registerModal').modal('hide');
            $('#forgotPasswordModal').modal('show');
            $('#forgotPasswordStep1').show();
            $('#forgotPasswordStep2').hide();
        }
    </script>

    {% if not user.is_authenticated %}
    <script>
    $(document).ready(function() {

        // 登录表单提交
        $('#loginForm').on('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            $.ajax({
                url: '{% url "login_user" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert(response.message);
                    }
                },
                error: function() {
                    alert('登录失败，请稍后重试');
                }
            });
        });

        // 注册表单提交
        $('#registerForm').on('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            $.ajax({
                url: '{% url "register_user" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        showLoginModal();
                        $('#registerForm')[0].reset();
                    } else {
                        alert(response.message);
                    }
                },
                error: function() {
                    alert('注册失败，请稍后重试');
                }
            });
        });

        // 注册表单验证相关变量
        let usernameCheckTimeout;
        let emailCheckTimeout;
        let usernameBlurred = false;
        let emailBlurred = false;
        let passwordBlurred = false;
        let confirmPasswordBlurred = false;

        // 用户名输入验证 - 实时检查
        $('#registerUsername').on('input', function() {
            const username = $(this).val().trim();
            const $input = $(this);
            const $icon = $('#usernameValidation i');
            const $error = $('#usernameError');

            // 清除之前的定时器
            clearTimeout(usernameCheckTimeout);

            if (!username) {
                // 只有在用户已经开始输入过的情况下才重置，否则保持初始状态
                if (usernameBlurred || $input.hasClass('is-valid') || $input.hasClass('is-invalid')) {
                    resetValidation($input, $icon, $error);
                }
                return;
            }

            // 当用户名长度达到3个字符时开始验证，延迟1000ms避免频繁请求
            if (username.length >= 3) {
                usernameCheckTimeout = setTimeout(function() {
                    checkUsernameAvailability(username, $input, $icon, $error);
                }, 800);
            }
        });

        // 用户名失去焦点时立即验证
        $('#registerUsername').on('blur', function() {
            usernameBlurred = true;
            const username = $(this).val().trim();
            const $input = $(this);
            const $icon = $('#usernameValidation i');
            const $error = $('#usernameError');

            if (username) {
                clearTimeout(usernameCheckTimeout);
                checkUsernameAvailability(username, $input, $icon, $error);
            } else {
                // 失去焦点时如果为空，显示错误状态
                setValidationState($input, $icon, $error, false, '请输入用户名');
            }
        });

        // 邮箱输入验证 - 在输入看起来完整时检查
        $('#registerEmail').on('input', function() {
            const email = $(this).val().trim();
            const $input = $(this);
            const $icon = $('#emailValidation i');
            const $error = $('#emailError');

            // 清除之前的定时器
            clearTimeout(emailCheckTimeout);

            if (!email) {
                // 只有在用户已经开始输入过的情况下才重置
                if (emailBlurred || $input.hasClass('is-valid') || $input.hasClass('is-invalid')) {
                    resetValidation($input, $icon, $error);
                }
                return;
            }

            // 如果邮箱格式看起来完整（包含@和.），则进行验证
            if (email.includes('@') && email.includes('.') && email.length > 8) {
                // 简单的邮箱格式检查
                const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                if (emailPattern.test(email)) {
                    emailCheckTimeout = setTimeout(function() {
                        checkEmailAvailability(email, $input, $icon, $error);
                    }, 1200);
                }
            }
        });

        // 邮箱失去焦点时立即验证
        $('#registerEmail').on('blur', function() {
            emailBlurred = true;
            const email = $(this).val().trim();
            const $input = $(this);
            const $icon = $('#emailValidation i');
            const $error = $('#emailError');

            if (email) {
                clearTimeout(emailCheckTimeout);
                checkEmailAvailability(email, $input, $icon, $error);
            } else {
                // 失去焦点时如果为空，显示错误状态
                setValidationState($input, $icon, $error, false, '请输入邮箱地址');
            }
        });

        // 密码输入验证 - 在输入达到最小长度时显示验证
        $('#registerPassword').on('input', function() {
            const password = $(this).val();
            const $input = $(this);
            const $icon = $('#passwordValidation i');
            const $error = $('#passwordError');

            if (!password) {
                // 只有在用户已经开始输入过的情况下才重置
                if (passwordBlurred || $input.hasClass('is-valid') || $input.hasClass('is-invalid')) {
                    resetValidation($input, $icon, $error);
                }
                return;
            }

            // 当密码长度达到6位或更多时，显示验证结果
            if (password.length >= 6) {
                validatePassword(password, $input, $icon, $error);
            } else if (passwordBlurred && password.length > 0) {
                // 如果已经失去过焦点且有输入，则显示长度不够的提示
                validatePassword(password, $input, $icon, $error);
            }

            // 如果确认密码已输入，重新验证确认密码
            const confirmPassword = $('#registerConfirmPassword').val();
            if (confirmPassword && (confirmPasswordBlurred || confirmPassword.length > 0)) {
                validateConfirmPassword(password, confirmPassword);
            }
        });

        // 密码失去焦点时触发验证
        $('#registerPassword').on('blur', function() {
            passwordBlurred = true;
            const password = $(this).val();
            const $input = $(this);
            const $icon = $('#passwordValidation i');
            const $error = $('#passwordError');

            if (password) {
                validatePassword(password, $input, $icon, $error);
            } else {
                // 失去焦点时如果为空，显示错误状态
                setValidationState($input, $icon, $error, false, '请输入密码');
            }

            // 重新验证确认密码
            const confirmPassword = $('#registerConfirmPassword').val();
            if (confirmPassword) {
                validateConfirmPassword(password, confirmPassword);
            }
        });

        // 确认密码输入验证 - 在输入时实时比较
        $('#registerConfirmPassword').on('input', function() {
            const password = $('#registerPassword').val();
            const confirmPassword = $(this).val();
            const $input = $(this);
            const $icon = $('#confirmPasswordValidation i');
            const $error = $('#confirmPasswordError');

            if (!confirmPassword) {
                // 只有在用户已经开始输入过的情况下才重置
                if (confirmPasswordBlurred || $input.hasClass('is-valid') || $input.hasClass('is-invalid')) {
                    resetValidation($input, $icon, $error);
                }
                return;
            }

            // 如果确认密码长度达到原密码长度，或者已经失去过焦点，则显示验证结果
            if (password && (confirmPassword.length >= password.length || confirmPasswordBlurred)) {
                validateConfirmPassword(password, confirmPassword);
            }
        });

        // 确认密码失去焦点时触发验证
        $('#registerConfirmPassword').on('blur', function() {
            confirmPasswordBlurred = true;
            const password = $('#registerPassword').val();
            const confirmPassword = $(this).val();

            if (confirmPassword) {
                validateConfirmPassword(password, confirmPassword);
            } else {
                // 失去焦点时如果为空，显示错误状态
                const $input = $(this);
                const $icon = $('#confirmPasswordValidation i');
                const $error = $('#confirmPasswordError');
                setValidationState($input, $icon, $error, false, '请再次输入密码');
            }
        });

        // 发送注册验证码
        $('#sendRegisterCode').on('click', function() {
            const email = $('#registerEmail').val();
            if (!email) {
                alert('请先输入邮箱');
                return;
            }

            const button = $(this);
            button.prop('disabled', true).text('发送中...');

            $.ajax({
                url: '{% url "send_verification_code" %}',
                type: 'POST',
                data: {
                    'email': email,
                    'purpose': 'register',
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    alert(response.message);
                    if (response.success) {
                        // 开始倒计时
                        let countdown = 60;
                        const timer = setInterval(function() {
                            button.text(countdown + 's后重发');
                            countdown--;
                            if (countdown < 0) {
                                clearInterval(timer);
                                button.prop('disabled', false).text('获取验证码');
                            }
                        }, 1000);
                    } else {
                        button.prop('disabled', false).text('获取验证码');
                    }
                },
                error: function() {
                    alert('发送失败，请稍后重试');
                    button.prop('disabled', false).text('获取验证码');
                }
            });
        });

        // 发送密码重置验证码
        $('#sendResetCode').on('click', function() {
            const email = $('#forgotEmail').val();
            if (!email) {
                alert('请先输入邮箱');
                return;
            }

            const button = $(this);
            button.prop('disabled', true).text('发送中...');

            $.ajax({
                url: '{% url "send_verification_code" %}',
                type: 'POST',
                data: {
                    'email': email,
                    'purpose': 'reset_password',
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    alert(response.message);
                    if (response.success) {
                        // 开始倒计时
                        let countdown = 60;
                        const timer = setInterval(function() {
                            button.text(countdown + 's后重发');
                            countdown--;
                            if (countdown < 0) {
                                clearInterval(timer);
                                button.prop('disabled', false).text('获取验证码');
                            }
                        }, 1000);
                    } else {
                        button.prop('disabled', false).text('获取验证码');
                    }
                },
                error: function() {
                    alert('发送失败，请稍后重试');
                    button.prop('disabled', false).text('获取验证码');
                }
            });
        });

        // 忘记密码表单提交（验证码验证）
        $('#forgotPasswordForm').on('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            $.ajax({
                url: '{% url "reset_password_request" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success && response.show_password_form) {
                        $('#resetEmail').val($('#forgotEmail').val());
                        $('#resetVerificationCode').val($('#forgotVerificationCode').val());
                        $('#forgotPasswordStep1').hide();
                        $('#forgotPasswordStep2').show();
                    } else {
                        alert(response.message);
                    }
                },
                error: function() {
                    alert('验证失败，请稍后重试');
                }
            });
        });

        // 重置密码表单提交
        $('#resetPasswordForm').on('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            $.ajax({
                url: '{% url "reset_password_confirm" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        showLoginModal();
                        $('#resetPasswordForm')[0].reset();
                    } else {
                        alert(response.message);
                    }
                },
                error: function() {
                    alert('重置失败，请稍后重试');
                }
            });
        });

        // 验证函数定义移到全局作用域
    });

    // 全局验证函数定义
    function checkUsernameAvailability(username, $input, $icon, $error) {
        // 先进行本地验证
        const localValidation = validateUsernameFormat(username);
        if (!localValidation.valid) {
            setValidationState($input, $icon, $error, false, localValidation.message);
            return;
        }

        // 显示加载状态
        $icon.parent().show();
        $icon.removeClass('fa-check fa-times fa-question').addClass('fa-spinner fa-spin');

        $.get('/auth/check-username/', { username: username })
            .done(function(response) {
                if (response.available) {
                    setValidationState($input, $icon, $error, true, '用户名可用');
                } else {
                    setValidationState($input, $icon, $error, false, response.message);
                }
            })
            .fail(function() {
                setValidationState($input, $icon, $error, false, '检查失败，请稍后重试');
            });
    }

    function validateUsernameFormat(username) {
        if (!username) {
            return { valid: false, message: '请输入用户名' };
        }

        if (username.length < 3) {
            return { valid: false, message: '用户名长度不能少于3个字符' };
        }

        if (username.length > 20) {
            return { valid: false, message: '用户名长度不能超过20个字符' };
        }

        // 检查是否以数字开头
        if (/^\d/.test(username)) {
            return { valid: false, message: '用户名不能以数字开头' };
        }

        // 检查字符是否合法
        if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(username)) {
            return { valid: false, message: '用户名只能包含字母、数字、下划线和中文' };
        }

        return { valid: true, message: '' };
    }

    function checkEmailAvailability(email, $input, $icon, $error) {
        // 先进行本地验证
        const localValidation = validateEmailFormat(email);
        if (!localValidation.valid) {
            setValidationState($input, $icon, $error, false, localValidation.message);
            return;
        }

        // 显示加载状态
        $icon.parent().show();
        $icon.removeClass('fa-check fa-times fa-question').addClass('fa-spinner fa-spin');

        $.get('/auth/check-email/', { email: email })
            .done(function(response) {
                if (response.available) {
                    setValidationState($input, $icon, $error, true, '邮箱可用');
                } else {
                    setValidationState($input, $icon, $error, false, response.message);
                }
            })
            .fail(function() {
                setValidationState($input, $icon, $error, false, '检查失败，请稍后重试');
            });
    }

    function validateEmailFormat(email) {
        if (!email) {
            return { valid: false, message: '请输入邮箱地址' };
        }

        const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (!emailPattern.test(email)) {
            return { valid: false, message: '邮箱格式不正确' };
        }

        return { valid: true, message: '' };
    }

    function validatePassword(password, $input, $icon, $error) {
        if (!password) {
            setValidationState($input, $icon, $error, false, '请输入密码');
            return;
        }

        if (password.length < 6) {
            setValidationState($input, $icon, $error, false, '密码长度不能少于6个字符');
        } else if (password.length > 20) {
            setValidationState($input, $icon, $error, false, '密码长度不能超过20个字符');
        } else if (!/[a-zA-Z]/.test(password) || !/[0-9]/.test(password)) {
            setValidationState($input, $icon, $error, false, '密码应包含字母和数字');
        } else {
            setValidationState($input, $icon, $error, true, '密码格式正确');
        }
    }

    function validateConfirmPassword(password, confirmPassword) {
        const $input = $('#registerConfirmPassword');
        const $icon = $('#confirmPasswordValidation i');
        const $error = $('#confirmPasswordError');

        if (!confirmPassword) {
            setValidationState($input, $icon, $error, false, '请再次输入密码');
            return;
        }

        if (!password) {
            setValidationState($input, $icon, $error, false, '请先输入密码');
            return;
        }

        if (password === confirmPassword) {
            setValidationState($input, $icon, $error, true, '密码匹配');
        } else {
            setValidationState($input, $icon, $error, false, '两次输入的密码不一致');
        }
    }

    function setValidationState($input, $icon, $error, isValid, message) {
        $icon.removeClass('fa-spinner fa-spin fa-check fa-times fa-question');

        // 显示验证图标容器
        $icon.parent().show();

        if (isValid) {
            $input.removeClass('is-invalid').addClass('is-valid');
            $icon.addClass('fa-check');
            $error.text('').hide();
        } else {
            $input.removeClass('is-valid').addClass('is-invalid');
            $icon.addClass('fa-times');
            $error.text(message).show();
        }
    }

    function resetValidation($input, $icon, $error) {
        $input.removeClass('is-valid is-invalid');
        $icon.removeClass('fa-spinner fa-spin fa-check fa-times fa-question');
        $error.text('').hide();

        // 隐藏验证图标容器
        $icon.parent().hide();
    }
    </script>
    {% endif %}

    <!-- 新用户欢迎弹窗 -->
    {% if user.is_authenticated and not user.preference.has_viewed_guide %}
    <!-- 新用户欢迎模态框 -->
    <div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="welcomeModalLabel">
                        <i class="fas fa-star me-2"></i>欢迎使用B站学习助手！
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-4">
                        <i class="fas fa-graduation-cap text-primary" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="text-primary mb-3">🎉 欢迎加入学习之旅！</h4>
                    <p class="mb-3">这是您第一次使用我们的平台，为了帮助您更好地使用各项功能，我们为您准备了详细的新手指南。</p>
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>新手指南包含：</strong>
                        <ul class="list-unstyled mt-2 mb-0">
                            <li>• 如何搜索和收藏B站视频</li>
                            <li>• 如何制定学习计划</li>
                            <li>• 如何使用AI学习助手</li>
                            <li>• 更多实用功能介绍</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-outline-secondary" id="skipGuideBtn">
                        <i class="fas fa-times me-1"></i>暂时跳过
                    </button>
                    <button type="button" class="btn btn-primary" id="viewGuideBtn">
                        <i class="fas fa-rocket me-1"></i>查看新手指南
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 新用户指南提醒脚本 -->
    {% if user.is_authenticated %}
    <script>
    $(document).ready(function() {
        // 检查用户是否为新注册用户且未查看新手指南
        {% if user.preference.has_viewed_guide == False %}
        // 检查用户注册时间，只对7天内注册的新用户显示提醒
        const userJoinDate = new Date('{{ user.date_joined|date:"Y-m-d" }}');
        const currentDate = new Date();
        const daysDiff = Math.floor((currentDate - userJoinDate) / (1000 * 60 * 60 * 24));

        if (daysDiff <= 7) {
            // 延迟1.5秒显示欢迎弹窗
            setTimeout(function() {
                $('#welcomeModal').modal('show');
            }, 1500);
        } else {
            // 超过7天的用户自动标记为已查看，不再提醒
            markGuideViewed();
        }

        // 查看新手指南按钮
        $('#viewGuideBtn').click(function() {
            $('#welcomeModal').modal('hide');
            window.open('{% url "beginner_guide" %}', '_blank');
            markGuideViewed();
        });

        // 跳过按钮
        $('#skipGuideBtn').click(function() {
            $('#welcomeModal').modal('hide');
            markGuideViewed();
        });

        // 标记为已查看
        function markGuideViewed() {
            $.ajax({
                url: '{% url "mark_guide_viewed" %}',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    console.log('已标记为查看过新手指南');
                    // 移除导航栏按钮的闪烁动画
                    $('.beginner-guide-btn').addClass('no-pulse');
                }
            });
        }
        {% endif %}
    });
    </script>
    {% endif %}

    <!-- 主题切换功能 -->
    <script>
    // 主题切换功能
    function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        // 立即切换主题
        html.setAttribute('data-theme', newTheme);

        // 如果用户已登录，保存主题偏好到服务器
        {% if user.is_authenticated %}
        $.ajax({
            url: '{% url "update_theme" %}',
            type: 'POST',
            data: {
                'theme': newTheme,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    // 可以显示成功消息，但通常主题切换不需要提示
                    console.log(response.message);
                }
            },
            error: function() {
                console.log('主题设置保存失败');
            }
        });
        {% else %}
        // 未登录用户，保存到localStorage
        localStorage.setItem('theme', newTheme);
        {% endif %}
    }

    // 页面加载时初始化主题
    $(document).ready(function() {
        {% if not user.is_authenticated %}
        // 未登录用户，从localStorage读取主题偏好
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
        }
        {% endif %}
    });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>