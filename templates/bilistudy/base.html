<!DOCTYPE html>
<html lang="zh-CN" data-theme="{% if user.is_authenticated and user_preference.theme_preference %}{{ user_preference.theme_preference }}{% else %}light{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Bç«™å­¦ä¹ å·¥å…·{% endblock %}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- æ·±è‰²ä¸»é¢˜CSS -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'bilistudy/css/dark-theme.css' %}">
    <!-- è‡ªå®šä¹‰CSS -->
    <style>
        :root {
            --primary-color: #5B8FF9;
            --primary-light: #EBF2FF;
            --secondary-color: #F6BD16;
            --dark-color: #2C3E50;
            --light-color: #F8F9FA;
            --accent-color: #5AD8A6;
            --text-color: #4A4A4A;
            --text-light: #8C8C8C;
            --border-color: #E8E8E8;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }
        
        html, body {
            height: 100%;
        }

        body {
            background-color: #FAFAFA;
            font-family: 'Noto Sans SC', sans-serif;
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
        }
        
        .navbar {
            background: #FFFFFF;
            box-shadow: 0 2px 10px var(--shadow-color);
            padding: 0.7rem 1rem;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
            font-size: 1.4rem;
        }

        /* æ–°æ‰‹æŒ‡å—æŒ‰é’®æ ·å¼ */
        .beginner-guide-btn {
            border-color: var(--primary-color) !important;
            color: var(--primary-color) !important;
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
            transition: all 0.3s ease;
            animation: pulse-hint 2s infinite;
        }

        .beginner-guide-btn:hover {
            background-color: var(--primary-color) !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        /* æ–°ç”¨æˆ·æç¤ºåŠ¨ç”» */
        @keyframes pulse-hint {
            0%, 70%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            35% {
                transform: scale(1.05);
                box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
            }
        }

        /* è€ç”¨æˆ·ä¸æ˜¾ç¤ºåŠ¨ç”» */
        .beginner-guide-btn.no-pulse {
            animation: none !important;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .beginner-guide-btn {
                font-size: 0.8rem;
                padding: 0.25rem 0.5rem;
                margin-left: 0.5rem !important;
            }

            .beginner-guide-btn .fas {
                display: none; /* ç§»åŠ¨ç«¯éšè—å›¾æ ‡ */
            }
        }

        @media (max-width: 576px) {
            .beginner-guide-btn {
                display: none; /* è¶…å°å±å¹•éšè—æŒ‰é’®ï¼Œé€šè¿‡èœå•è®¿é—® */
            }
        }
        
        .nav-link {
            color: var(--text-color) !important;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover, .nav-link:focus {
            color: var(--primary-color) !important;
            background-color: var(--primary-light);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(91, 143, 249, 0.2);
        }
        
        .btn-primary:hover {
            background-color: #4A7DE0;
            border-color: #4A7DE0;
            box-shadow: 0 4px 8px rgba(91, 143, 249, 0.3);
        }
        
        .btn-bili {
            background: linear-gradient(135deg, var(--primary-color), #7EB2FF);
            border: none;
            color: white;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(91, 143, 249, 0.2);
        }
        
        .btn-bili:hover {
            background: linear-gradient(135deg, #4A7DE0, var(--primary-color));
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(91, 143, 249, 0.3);
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
        }
        
        .card-title {
            color: var(--dark-color);
            font-weight: 600;
        }
        
        .video-item {
            cursor: pointer;
            transition: all 0.2s ease;
            border: none !important;
            margin-bottom: 0.5rem;
            border-radius: 8px !important;
        }
        
        .video-item:hover {
            background-color: var(--light-color);
        }
        
        .video-item.active {
            border-left: 4px solid var(--primary-color) !important;
            background-color: var(--primary-light);
        }
        
        .progress {
            height: 8px;
            border-radius: 4px;
            background-color: var(--border-color);
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(to right, var(--primary-color), #7EB2FF);
        }
        
        main {
            flex: 1;
            padding-bottom: 2rem;
        }

        footer {
            background-color: white;
            color: var(--text-light);
            padding: 2rem 0;
            margin-top: auto;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .pagination .page-link {
            color: var(--primary-color);
        }
        
        /* è‡ªå®šä¹‰å¤é€‰æ¡†æ ·å¼ */
        .custom-checkbox .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        /* æœç´¢æ¡†æ ·å¼ */
        .search-container {
            background: linear-gradient(135deg, #F5F7FA, #F8F9FA);
            padding: 1.5rem 0;
            margin-bottom: 0.5rem;
            border-radius: 0 0 30% 30% / 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-box {
            background-color: white;
            border-radius: 100px;
            padding: 0.5rem;
            box-shadow: 0 5px 20px var(--shadow-color);
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .search-box:focus-within {
            box-shadow: 0 5px 25px rgba(91, 143, 249, 0.25);
        }
        
        .search-input {
            border: none;
            box-shadow: none !important;
            padding-left: 1.5rem;
            flex: 1;
            background-color: transparent;
        }
        
        .search-input:focus {
            box-shadow: none;
            outline: none;
            border: none;
        }
        
        .search-btn {
            border-radius: 100px;
            min-width: 100px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
        }
        
        .search-btn i {
            font-size: 1rem;
        }
        
        /* åŠŸèƒ½å¡ç‰‡æ ·å¼ */
        .feature-card {
            text-align: center;
            padding: 2rem;
            height: 100%;
            transition: all 0.3s ease;
            background-color: white;
        }
        
        .feature-card:hover {
            transform: translateY(-10px);
        }
        
        .feature-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 2rem;
            color: white;
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .icon-courses {
            background: linear-gradient(135deg, var(--accent-color), #7EEFC6);
        }
        
        .icon-plan {
            background: linear-gradient(135deg, var(--primary-color), #7EB2FF);
        }
        
        .icon-ai {
            background: linear-gradient(135deg, var(--secondary-color), #FFD666);
        }
        
        /* è§†é¢‘è¯¦æƒ…é¡µæ ·å¼ */
        .video-cover {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .video-info {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .video-meta {
            display: flex;
            align-items: center;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }
        
        .video-meta i {
            width: 20px;
            margin-right: 0.5rem;
            color: var(--primary-color);
        }
        
        /* ç¾åŒ–æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #ccc;
        }
        
        /* æ ‡ç­¾æ ·å¼ */
        .badge {
            font-weight: 500;
            padding: 0.35em 0.65em;
        }
        
        .badge-light {
            background-color: var(--light-color);
            color: var(--text-light);
        }
        
        /* æç¤ºæ¡†æ ·å¼ */
        .alert {
            border-radius: 8px;
            border: none;
            box-shadow: 0 2px 10px var(--shadow-color);
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ç”¨æˆ·å¤´åƒæ ·å¼ */
        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary-color), #7EB2FF);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        /* è®¤è¯æ¨¡æ€æ¡†æ ·å¼ */
        .auth-modal .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .auth-modal .modal-header {
            border-bottom: 1px solid #e9ecef;
            padding: 1.5rem;
        }

        .auth-modal .modal-body {
            padding: 1.5rem;
        }

        .auth-modal .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(91, 143, 249, 0.25);
        }

        .auth-modal .input-group .btn {
            border-left: none;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="{% url 'index' %}">
                <i class="fas fa-graduation-cap me-2"></i>Bç«™å­¦ä¹ åŠ©æ‰‹
            </a>

            <!-- æ–°æ‰‹æŒ‡å—æŒ‰é’® -->
            {% if user.is_authenticated %}
                {% if not user.preference.has_viewed_guide %}
                    <!-- æ–°ç”¨æˆ·æ˜¾ç¤ºé—ªçƒåŠ¨ç”» -->
                    <a href="{% url 'beginner_guide' %}" class="btn btn-outline-primary btn-sm ms-3 beginner-guide-btn">
                        <i class="fas fa-question-circle me-1"></i>æ–°æ‰‹æŒ‡å—
                    </a>
                {% else %}
                    <!-- è€ç”¨æˆ·ä¸æ˜¾ç¤ºåŠ¨ç”» -->
                    <a href="{% url 'beginner_guide' %}" class="btn btn-outline-primary btn-sm ms-3 beginner-guide-btn no-pulse">
                        <i class="fas fa-question-circle me-1"></i>æ–°æ‰‹æŒ‡å—
                    </a>
                {% endif %}
            {% else %}
                <!-- æœªç™»å½•ç”¨æˆ·ä¸æ˜¾ç¤ºåŠ¨ç”» -->
                <a href="{% url 'beginner_guide' %}" class="btn btn-outline-primary btn-sm ms-3 beginner-guide-btn no-pulse">
                    <i class="fas fa-question-circle me-1"></i>æ–°æ‰‹æŒ‡å—
                </a>
            {% endif %}

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'index' %}">
                            <i class="fas fa-home me-1"></i> é¦–é¡µ
                        </a>
                    </li>
                    <li class="nav-item d-sm-none">
                        <a class="nav-link" href="{% url 'beginner_guide' %}">
                            <i class="fas fa-question-circle me-1"></i> æ–°æ‰‹æŒ‡å—
                        </a>
                    </li>
                    {% if user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'course_list' %}">
                            <i class="fas fa-list-check me-1"></i> æˆ‘çš„è¯¾ç¨‹
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'study_plans' %}">
                            <i class="fas fa-calendar-alt me-1"></i> æˆ‘çš„è®¡åˆ’
                        </a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'ai_assistant' %}">
                            <i class="fas fa-robot me-1"></i> AIåŠ©æ‰‹
                        </a>
                    </li>
                    {% if user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="user-avatar me-2">
                                <i class="fas fa-user"></i>
                            </div>
                            {{ user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><h6 class="dropdown-header">
                                <i class="fas fa-user me-1"></i>
                                {{ user.username }}
                            </h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'account_settings' %}">
                                <i class="fas fa-cog me-2"></i>è´¦æˆ·è®¾ç½®
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'logout_user' %}">
                                <i class="fas fa-sign-out-alt me-2"></i>é€€å‡ºç™»å½•
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <button class="theme-toggle nav-link border-0 bg-transparent" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                            <i class="fas fa-sun icon sun-icon"></i>
                            <i class="fas fa-moon icon moon-icon"></i>
                        </button>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <button class="btn btn-outline-primary me-2" onclick="showLoginModal()">
                            <i class="fas fa-sign-in-alt me-1"></i>ç™»å½•
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-primary me-2" onclick="showRegisterModal()">
                            <i class="fas fa-user-plus me-1"></i>æ³¨å†Œ
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="theme-toggle nav-link border-0 bg-transparent" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                            <i class="fas fa-sun icon sun-icon"></i>
                            <i class="fas fa-moon icon moon-icon"></i>
                        </button>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="container py-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
        
        {% block content %}{% endblock %}
    </main>

    <!-- é¡µè„š -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="mb-3">Bç«™å­¦ä¹ åŠ©æ‰‹</h5>
                    <p class="mb-0">ä¸€ä¸ªå¸®åŠ©ä½ æ›´å¥½åœ°åˆ©ç”¨Bç«™å­¦ä¹ èµ„æºçš„å·¥å…·</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">&copy; 2025 Bç«™å­¦ä¹ åŠ©æ‰‹ | æœ¬ç½‘ç«™ä»…ç”¨äºå­¦ä¹ å’Œç ”ç©¶</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- è®¤è¯æ¨¡æ€æ¡† -->
    {% if not user.is_authenticated %}
    {% include 'bilistudy/auth_modals.html' %}
    {% endif %}

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- è‡ªå®šä¹‰JS -->
    <script>
        // åŠ¨ç”»æ•ˆæœ
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.animate-fade-in').forEach(function(element, index) {
                setTimeout(function() {
                    element.style.opacity = '1';
                }, 100 * index);
            });
            
            // æ¸…é™¤é¡µé¢ä¸Šçš„HTMLæ ‡ç­¾
            cleanupHtmlTags();
        });
        
        // æ¸…é™¤é¡µé¢ä¸Šçš„HTMLæ ‡ç­¾ï¼Œç‰¹åˆ«æ˜¯æ ‡é¢˜ä¸­çš„emæ ‡ç­¾
        function cleanupHtmlTags() {
            // æŸ¥æ‰¾æ‰€æœ‰åŒ…å«æ–‡æœ¬çš„å…ƒç´ 
            const textElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, a, div, title');
            
            textElements.forEach(element => {
                // å¦‚æœå…ƒç´ åŒ…å«HTMLæ ‡ç­¾ï¼Œå°†å…¶æ›¿æ¢ä¸ºçº¯æ–‡æœ¬
                if (element.innerHTML.includes('<em class="keyword">')) {
                    let content = element.innerHTML;
                    // æ›¿æ¢æ‰€æœ‰<em class="keyword">æ ‡ç­¾
                    content = content.replace(/<em class="keyword">|<\/em>/g, '');
                    element.innerHTML = content;
                }
            });
            
            // ç‰¹åˆ«å¤„ç†document.title
            if (document.title.includes('<em class="keyword">')) {
                document.title = document.title.replace(/<em class="keyword">|<\/em>/g, '');
            }
        }

        // è®¤è¯æ¨¡æ€æ¡†å‡½æ•°
        function showLoginModal() {
            $('#registerModal').modal('hide');
            $('#forgotPasswordModal').modal('hide');
            $('#loginModal').modal('show');
        }

        function showRegisterModal() {
            $('#loginModal').modal('hide');
            $('#forgotPasswordModal').modal('hide');
            $('#registerModal').modal('show');
        }

        function showForgotPasswordModal() {
            $('#loginModal').modal('hide');
            $('#registerModal').modal('hide');
            $('#forgotPasswordModal').modal('show');
            $('#forgotPasswordStep1').show();
            $('#forgotPasswordStep2').hide();
        }
    </script>

    {% if not user.is_authenticated %}
    <script>
    $(document).ready(function() {

        // ç™»å½•è¡¨å•æäº¤
        $('#loginForm').on('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            $.ajax({
                url: '{% url "login_user" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert(response.message);
                    }
                },
                error: function() {
                    alert('ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            });
        });

        // æ³¨å†Œè¡¨å•æäº¤
        $('#registerForm').on('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            $.ajax({
                url: '{% url "register_user" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        showLoginModal();
                        $('#registerForm')[0].reset();
                    } else {
                        alert(response.message);
                    }
                },
                error: function() {
                    alert('æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            });
        });

        // æ³¨å†Œè¡¨å•éªŒè¯ç›¸å…³å˜é‡
        let usernameCheckTimeout;
        let emailCheckTimeout;
        let usernameBlurred = false;
        let emailBlurred = false;
        let passwordBlurred = false;
        let confirmPasswordBlurred = false;

        // ç”¨æˆ·åè¾“å…¥éªŒè¯ - å®æ—¶æ£€æŸ¥
        $('#registerUsername').on('input', function() {
            const username = $(this).val().trim();
            const $input = $(this);
            const $icon = $('#usernameValidation i');
            const $error = $('#usernameError');

            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            clearTimeout(usernameCheckTimeout);

            if (!username) {
                // åªæœ‰åœ¨ç”¨æˆ·å·²ç»å¼€å§‹è¾“å…¥è¿‡çš„æƒ…å†µä¸‹æ‰é‡ç½®ï¼Œå¦åˆ™ä¿æŒåˆå§‹çŠ¶æ€
                if (usernameBlurred || $input.hasClass('is-valid') || $input.hasClass('is-invalid')) {
                    resetValidation($input, $icon, $error);
                }
                return;
            }

            // å½“ç”¨æˆ·åé•¿åº¦è¾¾åˆ°3ä¸ªå­—ç¬¦æ—¶å¼€å§‹éªŒè¯ï¼Œå»¶è¿Ÿ1000msé¿å…é¢‘ç¹è¯·æ±‚
            if (username.length >= 3) {
                usernameCheckTimeout = setTimeout(function() {
                    checkUsernameAvailability(username, $input, $icon, $error);
                }, 800);
            }
        });

        // ç”¨æˆ·åå¤±å»ç„¦ç‚¹æ—¶ç«‹å³éªŒè¯
        $('#registerUsername').on('blur', function() {
            usernameBlurred = true;
            const username = $(this).val().trim();
            const $input = $(this);
            const $icon = $('#usernameValidation i');
            const $error = $('#usernameError');

            if (username) {
                clearTimeout(usernameCheckTimeout);
                checkUsernameAvailability(username, $input, $icon, $error);
            } else {
                // å¤±å»ç„¦ç‚¹æ—¶å¦‚æœä¸ºç©ºï¼Œæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                setValidationState($input, $icon, $error, false, 'è¯·è¾“å…¥ç”¨æˆ·å');
            }
        });

        // é‚®ç®±è¾“å…¥éªŒè¯ - åœ¨è¾“å…¥çœ‹èµ·æ¥å®Œæ•´æ—¶æ£€æŸ¥
        $('#registerEmail').on('input', function() {
            const email = $(this).val().trim();
            const $input = $(this);
            const $icon = $('#emailValidation i');
            const $error = $('#emailError');

            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            clearTimeout(emailCheckTimeout);

            if (!email) {
                // åªæœ‰åœ¨ç”¨æˆ·å·²ç»å¼€å§‹è¾“å…¥è¿‡çš„æƒ…å†µä¸‹æ‰é‡ç½®
                if (emailBlurred || $input.hasClass('is-valid') || $input.hasClass('is-invalid')) {
                    resetValidation($input, $icon, $error);
                }
                return;
            }

            // å¦‚æœé‚®ç®±æ ¼å¼çœ‹èµ·æ¥å®Œæ•´ï¼ˆåŒ…å«@å’Œ.ï¼‰ï¼Œåˆ™è¿›è¡ŒéªŒè¯
            if (email.includes('@') && email.includes('.') && email.length > 8) {
                // ç®€å•çš„é‚®ç®±æ ¼å¼æ£€æŸ¥
                const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                if (emailPattern.test(email)) {
                    emailCheckTimeout = setTimeout(function() {
                        checkEmailAvailability(email, $input, $icon, $error);
                    }, 1200);
                }
            }
        });

        // é‚®ç®±å¤±å»ç„¦ç‚¹æ—¶ç«‹å³éªŒè¯
        $('#registerEmail').on('blur', function() {
            emailBlurred = true;
            const email = $(this).val().trim();
            const $input = $(this);
            const $icon = $('#emailValidation i');
            const $error = $('#emailError');

            if (email) {
                clearTimeout(emailCheckTimeout);
                checkEmailAvailability(email, $input, $icon, $error);
            } else {
                // å¤±å»ç„¦ç‚¹æ—¶å¦‚æœä¸ºç©ºï¼Œæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                setValidationState($input, $icon, $error, false, 'è¯·è¾“å…¥é‚®ç®±åœ°å€');
            }
        });

        // å¯†ç è¾“å…¥éªŒè¯ - åœ¨è¾“å…¥è¾¾åˆ°æœ€å°é•¿åº¦æ—¶æ˜¾ç¤ºéªŒè¯
        $('#registerPassword').on('input', function() {
            const password = $(this).val();
            const $input = $(this);
            const $icon = $('#passwordValidation i');
            const $error = $('#passwordError');

            if (!password) {
                // åªæœ‰åœ¨ç”¨æˆ·å·²ç»å¼€å§‹è¾“å…¥è¿‡çš„æƒ…å†µä¸‹æ‰é‡ç½®
                if (passwordBlurred || $input.hasClass('is-valid') || $input.hasClass('is-invalid')) {
                    resetValidation($input, $icon, $error);
                }
                return;
            }

            // å½“å¯†ç é•¿åº¦è¾¾åˆ°6ä½æˆ–æ›´å¤šæ—¶ï¼Œæ˜¾ç¤ºéªŒè¯ç»“æœ
            if (password.length >= 6) {
                validatePassword(password, $input, $icon, $error);
            } else if (passwordBlurred && password.length > 0) {
                // å¦‚æœå·²ç»å¤±å»è¿‡ç„¦ç‚¹ä¸”æœ‰è¾“å…¥ï¼Œåˆ™æ˜¾ç¤ºé•¿åº¦ä¸å¤Ÿçš„æç¤º
                validatePassword(password, $input, $icon, $error);
            }

            // å¦‚æœç¡®è®¤å¯†ç å·²è¾“å…¥ï¼Œé‡æ–°éªŒè¯ç¡®è®¤å¯†ç 
            const confirmPassword = $('#registerConfirmPassword').val();
            if (confirmPassword && (confirmPasswordBlurred || confirmPassword.length > 0)) {
                validateConfirmPassword(password, confirmPassword);
            }
        });

        // å¯†ç å¤±å»ç„¦ç‚¹æ—¶è§¦å‘éªŒè¯
        $('#registerPassword').on('blur', function() {
            passwordBlurred = true;
            const password = $(this).val();
            const $input = $(this);
            const $icon = $('#passwordValidation i');
            const $error = $('#passwordError');

            if (password) {
                validatePassword(password, $input, $icon, $error);
            } else {
                // å¤±å»ç„¦ç‚¹æ—¶å¦‚æœä¸ºç©ºï¼Œæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                setValidationState($input, $icon, $error, false, 'è¯·è¾“å…¥å¯†ç ');
            }

            // é‡æ–°éªŒè¯ç¡®è®¤å¯†ç 
            const confirmPassword = $('#registerConfirmPassword').val();
            if (confirmPassword) {
                validateConfirmPassword(password, confirmPassword);
            }
        });

        // ç¡®è®¤å¯†ç è¾“å…¥éªŒè¯ - åœ¨è¾“å…¥æ—¶å®æ—¶æ¯”è¾ƒ
        $('#registerConfirmPassword').on('input', function() {
            const password = $('#registerPassword').val();
            const confirmPassword = $(this).val();
            const $input = $(this);
            const $icon = $('#confirmPasswordValidation i');
            const $error = $('#confirmPasswordError');

            if (!confirmPassword) {
                // åªæœ‰åœ¨ç”¨æˆ·å·²ç»å¼€å§‹è¾“å…¥è¿‡çš„æƒ…å†µä¸‹æ‰é‡ç½®
                if (confirmPasswordBlurred || $input.hasClass('is-valid') || $input.hasClass('is-invalid')) {
                    resetValidation($input, $icon, $error);
                }
                return;
            }

            // å¦‚æœç¡®è®¤å¯†ç é•¿åº¦è¾¾åˆ°åŸå¯†ç é•¿åº¦ï¼Œæˆ–è€…å·²ç»å¤±å»è¿‡ç„¦ç‚¹ï¼Œåˆ™æ˜¾ç¤ºéªŒè¯ç»“æœ
            if (password && (confirmPassword.length >= password.length || confirmPasswordBlurred)) {
                validateConfirmPassword(password, confirmPassword);
            }
        });

        // ç¡®è®¤å¯†ç å¤±å»ç„¦ç‚¹æ—¶è§¦å‘éªŒè¯
        $('#registerConfirmPassword').on('blur', function() {
            confirmPasswordBlurred = true;
            const password = $('#registerPassword').val();
            const confirmPassword = $(this).val();

            if (confirmPassword) {
                validateConfirmPassword(password, confirmPassword);
            } else {
                // å¤±å»ç„¦ç‚¹æ—¶å¦‚æœä¸ºç©ºï¼Œæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                const $input = $(this);
                const $icon = $('#confirmPasswordValidation i');
                const $error = $('#confirmPasswordError');
                setValidationState($input, $icon, $error, false, 'è¯·å†æ¬¡è¾“å…¥å¯†ç ');
            }
        });

        // å‘é€æ³¨å†ŒéªŒè¯ç 
        $('#sendRegisterCode').on('click', function() {
            const email = $('#registerEmail').val();
            if (!email) {
                alert('è¯·å…ˆè¾“å…¥é‚®ç®±');
                return;
            }

            const button = $(this);
            button.prop('disabled', true).text('å‘é€ä¸­...');

            $.ajax({
                url: '{% url "send_verification_code" %}',
                type: 'POST',
                data: {
                    'email': email,
                    'purpose': 'register',
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    alert(response.message);
                    if (response.success) {
                        // å¼€å§‹å€’è®¡æ—¶
                        let countdown = 60;
                        const timer = setInterval(function() {
                            button.text(countdown + 'såé‡å‘');
                            countdown--;
                            if (countdown < 0) {
                                clearInterval(timer);
                                button.prop('disabled', false).text('è·å–éªŒè¯ç ');
                            }
                        }, 1000);
                    } else {
                        button.prop('disabled', false).text('è·å–éªŒè¯ç ');
                    }
                },
                error: function() {
                    alert('å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    button.prop('disabled', false).text('è·å–éªŒè¯ç ');
                }
            });
        });

        // å‘é€å¯†ç é‡ç½®éªŒè¯ç 
        $('#sendResetCode').on('click', function() {
            const email = $('#forgotEmail').val();
            if (!email) {
                alert('è¯·å…ˆè¾“å…¥é‚®ç®±');
                return;
            }

            const button = $(this);
            button.prop('disabled', true).text('å‘é€ä¸­...');

            $.ajax({
                url: '{% url "send_verification_code" %}',
                type: 'POST',
                data: {
                    'email': email,
                    'purpose': 'reset_password',
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    alert(response.message);
                    if (response.success) {
                        // å¼€å§‹å€’è®¡æ—¶
                        let countdown = 60;
                        const timer = setInterval(function() {
                            button.text(countdown + 'såé‡å‘');
                            countdown--;
                            if (countdown < 0) {
                                clearInterval(timer);
                                button.prop('disabled', false).text('è·å–éªŒè¯ç ');
                            }
                        }, 1000);
                    } else {
                        button.prop('disabled', false).text('è·å–éªŒè¯ç ');
                    }
                },
                error: function() {
                    alert('å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    button.prop('disabled', false).text('è·å–éªŒè¯ç ');
                }
            });
        });

        // å¿˜è®°å¯†ç è¡¨å•æäº¤ï¼ˆéªŒè¯ç éªŒè¯ï¼‰
        $('#forgotPasswordForm').on('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            $.ajax({
                url: '{% url "reset_password_request" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success && response.show_password_form) {
                        $('#resetEmail').val($('#forgotEmail').val());
                        $('#resetVerificationCode').val($('#forgotVerificationCode').val());
                        $('#forgotPasswordStep1').hide();
                        $('#forgotPasswordStep2').show();
                    } else {
                        alert(response.message);
                    }
                },
                error: function() {
                    alert('éªŒè¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            });
        });

        // é‡ç½®å¯†ç è¡¨å•æäº¤
        $('#resetPasswordForm').on('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            $.ajax({
                url: '{% url "reset_password_confirm" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        showLoginModal();
                        $('#resetPasswordForm')[0].reset();
                    } else {
                        alert(response.message);
                    }
                },
                error: function() {
                    alert('é‡ç½®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            });
        });

        // éªŒè¯å‡½æ•°å®šä¹‰ç§»åˆ°å…¨å±€ä½œç”¨åŸŸ
    });

    // å…¨å±€éªŒè¯å‡½æ•°å®šä¹‰
    function checkUsernameAvailability(username, $input, $icon, $error) {
        // å…ˆè¿›è¡Œæœ¬åœ°éªŒè¯
        const localValidation = validateUsernameFormat(username);
        if (!localValidation.valid) {
            setValidationState($input, $icon, $error, false, localValidation.message);
            return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        $icon.parent().show();
        $icon.removeClass('fa-check fa-times fa-question').addClass('fa-spinner fa-spin');

        $.get('/auth/check-username/', { username: username })
            .done(function(response) {
                if (response.available) {
                    setValidationState($input, $icon, $error, true, 'ç”¨æˆ·åå¯ç”¨');
                } else {
                    setValidationState($input, $icon, $error, false, response.message);
                }
            })
            .fail(function() {
                setValidationState($input, $icon, $error, false, 'æ£€æŸ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
    }

    function validateUsernameFormat(username) {
        if (!username) {
            return { valid: false, message: 'è¯·è¾“å…¥ç”¨æˆ·å' };
        }

        if (username.length < 3) {
            return { valid: false, message: 'ç”¨æˆ·åé•¿åº¦ä¸èƒ½å°‘äº3ä¸ªå­—ç¬¦' };
        }

        if (username.length > 20) {
            return { valid: false, message: 'ç”¨æˆ·åé•¿åº¦ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦' };
        }

        // æ£€æŸ¥æ˜¯å¦ä»¥æ•°å­—å¼€å¤´
        if (/^\d/.test(username)) {
            return { valid: false, message: 'ç”¨æˆ·åä¸èƒ½ä»¥æ•°å­—å¼€å¤´' };
        }

        // æ£€æŸ¥å­—ç¬¦æ˜¯å¦åˆæ³•
        if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(username)) {
            return { valid: false, message: 'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­æ–‡' };
        }

        return { valid: true, message: '' };
    }

    function checkEmailAvailability(email, $input, $icon, $error) {
        // å…ˆè¿›è¡Œæœ¬åœ°éªŒè¯
        const localValidation = validateEmailFormat(email);
        if (!localValidation.valid) {
            setValidationState($input, $icon, $error, false, localValidation.message);
            return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        $icon.parent().show();
        $icon.removeClass('fa-check fa-times fa-question').addClass('fa-spinner fa-spin');

        $.get('/auth/check-email/', { email: email })
            .done(function(response) {
                if (response.available) {
                    setValidationState($input, $icon, $error, true, 'é‚®ç®±å¯ç”¨');
                } else {
                    setValidationState($input, $icon, $error, false, response.message);
                }
            })
            .fail(function() {
                setValidationState($input, $icon, $error, false, 'æ£€æŸ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
    }

    function validateEmailFormat(email) {
        if (!email) {
            return { valid: false, message: 'è¯·è¾“å…¥é‚®ç®±åœ°å€' };
        }

        const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (!emailPattern.test(email)) {
            return { valid: false, message: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®' };
        }

        return { valid: true, message: '' };
    }

    function validatePassword(password, $input, $icon, $error) {
        if (!password) {
            setValidationState($input, $icon, $error, false, 'è¯·è¾“å…¥å¯†ç ');
            return;
        }

        if (password.length < 6) {
            setValidationState($input, $icon, $error, false, 'å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä¸ªå­—ç¬¦');
        } else if (password.length > 20) {
            setValidationState($input, $icon, $error, false, 'å¯†ç é•¿åº¦ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦');
        } else if (!/[a-zA-Z]/.test(password) || !/[0-9]/.test(password)) {
            setValidationState($input, $icon, $error, false, 'å¯†ç åº”åŒ…å«å­—æ¯å’Œæ•°å­—');
        } else {
            setValidationState($input, $icon, $error, true, 'å¯†ç æ ¼å¼æ­£ç¡®');
        }
    }

    function validateConfirmPassword(password, confirmPassword) {
        const $input = $('#registerConfirmPassword');
        const $icon = $('#confirmPasswordValidation i');
        const $error = $('#confirmPasswordError');

        if (!confirmPassword) {
            setValidationState($input, $icon, $error, false, 'è¯·å†æ¬¡è¾“å…¥å¯†ç ');
            return;
        }

        if (!password) {
            setValidationState($input, $icon, $error, false, 'è¯·å…ˆè¾“å…¥å¯†ç ');
            return;
        }

        if (password === confirmPassword) {
            setValidationState($input, $icon, $error, true, 'å¯†ç åŒ¹é…');
        } else {
            setValidationState($input, $icon, $error, false, 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
        }
    }

    function setValidationState($input, $icon, $error, isValid, message) {
        $icon.removeClass('fa-spinner fa-spin fa-check fa-times fa-question');

        // æ˜¾ç¤ºéªŒè¯å›¾æ ‡å®¹å™¨
        $icon.parent().show();

        if (isValid) {
            $input.removeClass('is-invalid').addClass('is-valid');
            $icon.addClass('fa-check');
            $error.text('').hide();
        } else {
            $input.removeClass('is-valid').addClass('is-invalid');
            $icon.addClass('fa-times');
            $error.text(message).show();
        }
    }

    function resetValidation($input, $icon, $error) {
        $input.removeClass('is-valid is-invalid');
        $icon.removeClass('fa-spinner fa-spin fa-check fa-times fa-question');
        $error.text('').hide();

        // éšè—éªŒè¯å›¾æ ‡å®¹å™¨
        $icon.parent().hide();
    }
    </script>
    {% endif %}

    <!-- æ–°ç”¨æˆ·æ¬¢è¿å¼¹çª— -->
    {% if user.is_authenticated and not user.preference.has_viewed_guide %}
    <!-- æ–°ç”¨æˆ·æ¬¢è¿æ¨¡æ€æ¡† -->
    <div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="welcomeModalLabel">
                        <i class="fas fa-star me-2"></i>æ¬¢è¿ä½¿ç”¨Bç«™å­¦ä¹ åŠ©æ‰‹ï¼
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-4">
                        <i class="fas fa-graduation-cap text-primary" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="text-primary mb-3">ğŸ‰ æ¬¢è¿åŠ å…¥å­¦ä¹ ä¹‹æ—…ï¼</h4>
                    <p class="mb-3">è¿™æ˜¯æ‚¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æˆ‘ä»¬çš„å¹³å°ï¼Œä¸ºäº†å¸®åŠ©æ‚¨æ›´å¥½åœ°ä½¿ç”¨å„é¡¹åŠŸèƒ½ï¼Œæˆ‘ä»¬ä¸ºæ‚¨å‡†å¤‡äº†è¯¦ç»†çš„æ–°æ‰‹æŒ‡å—ã€‚</p>
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>æ–°æ‰‹æŒ‡å—åŒ…å«ï¼š</strong>
                        <ul class="list-unstyled mt-2 mb-0">
                            <li>â€¢ å¦‚ä½•æœç´¢å’Œæ”¶è—Bç«™è§†é¢‘</li>
                            <li>â€¢ å¦‚ä½•åˆ¶å®šå­¦ä¹ è®¡åˆ’</li>
                            <li>â€¢ å¦‚ä½•ä½¿ç”¨AIå­¦ä¹ åŠ©æ‰‹</li>
                            <li>â€¢ æ›´å¤šå®ç”¨åŠŸèƒ½ä»‹ç»</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-outline-secondary" id="skipGuideBtn">
                        <i class="fas fa-times me-1"></i>æš‚æ—¶è·³è¿‡
                    </button>
                    <button type="button" class="btn btn-primary" id="viewGuideBtn">
                        <i class="fas fa-rocket me-1"></i>æŸ¥çœ‹æ–°æ‰‹æŒ‡å—
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- æ–°ç”¨æˆ·æŒ‡å—æé†’è„šæœ¬ -->
    {% if user.is_authenticated %}
    <script>
    $(document).ready(function() {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºæ–°æ³¨å†Œç”¨æˆ·ä¸”æœªæŸ¥çœ‹æ–°æ‰‹æŒ‡å—
        {% if user.preference.has_viewed_guide == False %}
        // æ£€æŸ¥ç”¨æˆ·æ³¨å†Œæ—¶é—´ï¼Œåªå¯¹7å¤©å†…æ³¨å†Œçš„æ–°ç”¨æˆ·æ˜¾ç¤ºæé†’
        const userJoinDate = new Date('{{ user.date_joined|date:"Y-m-d" }}');
        const currentDate = new Date();
        const daysDiff = Math.floor((currentDate - userJoinDate) / (1000 * 60 * 60 * 24));

        if (daysDiff <= 7) {
            // å»¶è¿Ÿ1.5ç§’æ˜¾ç¤ºæ¬¢è¿å¼¹çª—
            setTimeout(function() {
                $('#welcomeModal').modal('show');
            }, 1500);
        } else {
            // è¶…è¿‡7å¤©çš„ç”¨æˆ·è‡ªåŠ¨æ ‡è®°ä¸ºå·²æŸ¥çœ‹ï¼Œä¸å†æé†’
            markGuideViewed();
        }

        // æŸ¥çœ‹æ–°æ‰‹æŒ‡å—æŒ‰é’®
        $('#viewGuideBtn').click(function() {
            $('#welcomeModal').modal('hide');
            window.open('{% url "beginner_guide" %}', '_blank');
            markGuideViewed();
        });

        // è·³è¿‡æŒ‰é’®
        $('#skipGuideBtn').click(function() {
            $('#welcomeModal').modal('hide');
            markGuideViewed();
        });

        // æ ‡è®°ä¸ºå·²æŸ¥çœ‹
        function markGuideViewed() {
            $.ajax({
                url: '{% url "mark_guide_viewed" %}',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    console.log('å·²æ ‡è®°ä¸ºæŸ¥çœ‹è¿‡æ–°æ‰‹æŒ‡å—');
                    // ç§»é™¤å¯¼èˆªæ æŒ‰é’®çš„é—ªçƒåŠ¨ç”»
                    $('.beginner-guide-btn').addClass('no-pulse');
                }
            });
        }
        {% endif %}
    });
    </script>
    {% endif %}

    <!-- ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ -->
    <script>
    // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
    function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        // ç«‹å³åˆ‡æ¢ä¸»é¢˜
        html.setAttribute('data-theme', newTheme);

        // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œä¿å­˜ä¸»é¢˜åå¥½åˆ°æœåŠ¡å™¨
        {% if user.is_authenticated %}
        $.ajax({
            url: '{% url "update_theme" %}',
            type: 'POST',
            data: {
                'theme': newTheme,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    // å¯ä»¥æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼Œä½†é€šå¸¸ä¸»é¢˜åˆ‡æ¢ä¸éœ€è¦æç¤º
                    console.log(response.message);
                }
            },
            error: function() {
                console.log('ä¸»é¢˜è®¾ç½®ä¿å­˜å¤±è´¥');
            }
        });
        {% else %}
        // æœªç™»å½•ç”¨æˆ·ï¼Œä¿å­˜åˆ°localStorage
        localStorage.setItem('theme', newTheme);
        {% endif %}
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¸»é¢˜
    $(document).ready(function() {
        {% if not user.is_authenticated %}
        // æœªç™»å½•ç”¨æˆ·ï¼Œä»localStorageè¯»å–ä¸»é¢˜åå¥½
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
        }
        {% endif %}
    });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>