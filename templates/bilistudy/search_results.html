{% extends 'bilistudy/base.html' %}

{% block title %}搜索结果 - {{ keyword }}{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'bilistudy/css/custom-styles.css' %}">
<style>
    .detail-sidebar {
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 270px);
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--primary-color) #f0f0f0;
    }
    
    .detail-sidebar::-webkit-scrollbar {
        width: 6px;
    }
    
    .detail-sidebar::-webkit-scrollbar-track {
        background: #f0f0f0;
        border-radius: 10px;
    }
    
    .detail-sidebar::-webkit-scrollbar-thumb {
        background-color: var(--primary-color);
        border-radius: 10px;
    }
    
    .video-list-container {
        max-height: calc(100vh - 270px);
        overflow-y: auto;
        padding-right: 10px;
    }
    
    .video-item {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .video-item:hover {
        transform: translateY(-3px);
    }
    
    .video-item.active {
        border-left: 4px solid var(--primary-color);
        background-color: var(--primary-light);
    }

    /* 分集显示样式 */
    .episodes-container {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e0 #f7fafc;
    }

    .episodes-container::-webkit-scrollbar {
        width: 6px;
    }

    .episodes-container::-webkit-scrollbar-track {
        background: #f7fafc;
        border-radius: 3px;
    }

    .episodes-container::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 3px;
    }

    .episodes-container::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }

    .episode-item {
        transition: all 0.2s ease;
    }

    .episode-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    }

    .hover-shadow {
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .btn-hover {
        transition: all 0.2s ease;
    }

    .btn-hover:hover {
        transform: scale(1.05);
    }

    .episode-title {
        line-height: 1.3;
    }

    .badge.fs-6 {
        font-size: 0.8rem !important;
        padding: 0.4em 0.6em;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<!-- 搜索结果头部 -->
<div class="card mb-4 border-0 shadow-sm">
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h4 class="mb-0">搜索结果: "{{ keyword }}"</h4>
            <form id="searchFormResults" action="{% url 'search_videos' %}" method="get" class="d-flex" style="width: 300px;">
                <div class="search-box w-100">
                    <input type="text" id="searchInputResults" name="keyword" class="form-control search-input" value="{{ keyword }}" required>
                    <input type="hidden" name="sort" value="{{ sort_type }}">
                    <input type="hidden" id="skipWarningResults" name="skip_warning" value="false">
                    <button type="submit" class="btn btn-bili search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </form>
        </div>
        
        {% if not is_single_video %}
        <div class="btn-group">
            <a href="{% url 'search_videos' %}?keyword={{ keyword }}&sort=default&page={{ page }}" class="btn btn-sm {% if sort_type == 'default' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="fas fa-sort me-1"></i> 综合排序
            </a>
            <a href="{% url 'search_videos' %}?keyword={{ keyword }}&sort=view&page={{ page }}" class="btn btn-sm {% if sort_type == 'view' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="fas fa-eye me-1"></i> 播放量
            </a>
            <a href="{% url 'search_videos' %}?keyword={{ keyword }}&sort=like&page={{ page }}" class="btn btn-sm {% if sort_type == 'like' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="fas fa-thumbs-up me-1"></i> 点赞数
            </a>
        </div>
        {% else %}
        <div class="text-muted small">
            <i class="fas fa-info-circle me-1"></i>
            单视频详情模式
        </div>
        {% endif %}
    </div>
</div>

<!-- 内容检测提示 -->
{% if content_analysis %}
    {% if content_analysis.is_learning_related|yesno:"true,false,unknown" == "false" %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-start">
                <i class="fas fa-exclamation-triangle me-3 mt-1" style="color: #856404;"></i>
                <div class="flex-grow-1">
                    <h6 class="alert-heading mb-2">
                        <i class="fas fa-graduation-cap me-2"></i>学习内容提醒
                    </h6>
                    <p class="mb-2">
                        <strong>检测到搜索内容可能与学习无关。</strong><br>
                        {{ content_analysis.reason }}
                    </p>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            <strong>建议：</strong>尝试搜索教程、课程、学习等相关内容，获得更好的学习体验。
                        </small>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-cog me-1"></i>
                            不想收到此类提醒？可以在
                            <a href="/auth/account-settings/" class="text-decoration-none">
                                <strong>账户设置</strong>
                            </a>
                            中的"启用学习内容提醒"中关闭此功能
                        </small>
                    </div>
                    {% if content_analysis.details %}
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#analysisDetails">
                                <i class="fas fa-info-circle me-1"></i>查看详细分析
                            </button>
                            <div class="collapse mt-2" id="analysisDetails">
                                <div class="card card-body bg-light">
                                    <small>
                                        {% for detail in content_analysis.details %}
                                            <div class="mb-1">
                                                <span class="badge bg-secondary">{{ detail.source }}</span>
                                                {% if detail.is_learning %}
                                                    <span class="badge bg-success">学习相关</span>
                                                {% else %}
                                                    <span class="badge bg-danger">非学习相关</span>
                                                {% endif %}
                                                <span class="text-muted">{{ detail.reason }}</span>
                                            </div>
                                        {% endfor %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% elif content_analysis.need_ai_analysis %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-start">
                <i class="fas fa-robot me-3 mt-1" style="color: #0c5460;"></i>
                <div class="flex-grow-1">
                    <h6 class="alert-heading mb-2">
                        <i class="fas fa-brain me-2"></i>AI语义分析
                    </h6>
                    <p class="mb-2">
                        关键词库无法明确判断内容类型，建议进行AI语义分析以获得更准确的学习相关性判断。
                    </p>
                    <button class="btn btn-sm btn-primary" onclick="performAIAnalysis()">
                        <i class="fas fa-magic me-1"></i>进行AI分析
                    </button>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endif %}
{% endif %}

{% if is_single_video %}
<!-- 单视频详情显示 -->
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-video me-2 text-primary"></i>视频详情
                </h5>
            </div>
            <div class="card-body p-4" id="singleVideoDetail">
                <!-- 直接显示单视频详情 -->
                {% if single_video %}
                <div class="row">
                    <div class="col-md-4">
                        <div class="position-relative">
                            <img src="{{ single_video.cover }}" class="img-fluid rounded shadow-sm" alt="视频封面">
                            <div class="position-absolute bottom-0 end-0 bg-dark text-white px-2 py-1 rounded-start small">
                                <i class="fas fa-play me-1"></i>
                                {% if single_video.play_count >= 10000 %}
                                    {{ single_video.play_count|floatformat:0|slice:":3" }}万+
                                {% else %}
                                    {{ single_video.play_count|floatformat:0 }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h4 class="mb-3 text-primary">{{ single_video.title }}</h4>

                        <div class="row mb-3">
                            <div class="col-sm-6">
                                <p class="mb-2">
                                    <i class="fas fa-user me-2 text-muted"></i>
                                    <strong>作者：</strong>{{ single_video.author }}
                                </p>
                                <p class="mb-2">
                                    <i class="fas fa-calendar me-2 text-muted"></i>
                                    <strong>发布：</strong>{{ single_video.pub_date }}
                                </p>
                            </div>
                            <div class="col-sm-6">
                                <p class="mb-2">
                                    <i class="fas fa-eye me-2 text-muted"></i>
                                    <strong>播放：</strong>
                                    {% if single_video.play_count >= 10000 %}
                                        {{ single_video.play_count|floatformat:0|slice:":3" }}万+
                                    {% else %}
                                        {{ single_video.play_count|floatformat:0 }}
                                    {% endif %}
                                </p>
                                <p class="mb-2">
                                    <i class="fas fa-thumbs-up me-2 text-muted"></i>
                                    <strong>点赞：</strong>
                                    {% if single_video.like_count >= 10000 %}
                                        {{ single_video.like_count|floatformat:0|slice:":3" }}万+
                                    {% else %}
                                        {{ single_video.like_count|floatformat:0 }}
                                    {% endif %}
                                </p>
                            </div>
                        </div>

                        {% if single_video.description %}
                        <div class="mb-3">
                            <h6><i class="fas fa-info-circle me-2 text-muted"></i>视频简介</h6>
                            <p class="text-muted small">{{ single_video.description|truncatewords:30 }}</p>
                        </div>
                        {% endif %}

                        <!-- 视频分集信息 -->
                        {% if episodes and episodes.count > 1 %}
                        <div class="mb-3">
                            <h6><i class="fas fa-list me-2 text-muted"></i>视频分集
                                <span class="badge bg-secondary ms-2">共{{ episodes.count }}集</span>
                            </h6>
                            <div class="episodes-container border rounded p-2" style="max-height: 250px; overflow-y: auto; background-color: #f8f9fa;">
                                {% for episode in episodes %}
                                <div class="episode-item d-flex align-items-center p-2 mb-2 bg-white border rounded shadow-sm hover-shadow">
                                    <div class="episode-number me-3">
                                        <span class="badge bg-primary fs-6">P{{ episode.order }}</span>
                                    </div>
                                    <div class="episode-info flex-grow-1">
                                        <div class="episode-title text-dark mb-1" style="font-size: 0.9rem; font-weight: 500;">
                                            {{ episode.title|truncatechars:40 }}
                                        </div>
                                        <div class="episode-duration text-muted small">
                                            <i class="fas fa-clock me-1"></i>
                                            {% if episode.duration %}
                                                <span class="duration-text">{{ episode.duration }}秒</span>
                                            {% else %}
                                                <span class="text-muted">时长未知</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="episode-actions">
                                        <a href="https://www.bilibili.com/video/{{ single_video.bvid }}?p={{ episode.order }}"
                                           target="_blank" class="btn btn-sm btn-outline-primary btn-hover">
                                            <i class="fas fa-play me-1"></i>播放
                                        </a>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% elif episodes.count == 1 %}
                        <div class="mb-3">
                            <h6><i class="fas fa-video me-2 text-muted"></i>单集视频</h6>
                            <div class="alert alert-info py-2">
                                <i class="fas fa-info-circle me-2"></i>
                                这是一个单集视频，时长：
                                {% if episodes.first.duration %}
                                    <span class="duration-text fw-bold">{{ episodes.first.duration }}秒</span>
                                {% else %}
                                    <span class="text-muted">未知</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- 添加到课程表单 -->
                        <div class="mt-4 border-top pt-4">
                            {% if not is_in_course_list %}
                            <form class="add-course-form" data-bvid="{{ single_video.bvid }}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-graduation-cap me-2 text-primary"></i>
                                        课程名称 (默认: <span class="text-primary">{{ single_video.title }}</span>):
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="fas fa-book text-muted"></i>
                                        </span>
                                        <input type="text" class="form-control" name="custom_title"
                                               placeholder="请输入课程名称" value="{{ single_video.title }}" onfocus="this.select()">
                                    </div>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-plus me-2"></i>添加到我的课程
                                    </button>
                                    <a href="https://www.bilibili.com/video/{{ single_video.bvid }}" target="_blank" class="btn btn-outline-primary">
                                        <i class="fas fa-external-link-alt me-2"></i>在B站观看
                                    </a>
                                </div>
                            </form>
                            {% else %}
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>已添加</strong> - 该视频已在您的课程列表中
                            </div>
                            <div class="d-grid gap-2">
                                <a href="{% url 'course_list' %}" class="btn btn-success">
                                    <i class="fas fa-book me-2"></i>查看我的课程
                                </a>
                                <a href="https://www.bilibili.com/video/{{ single_video.bvid }}" target="_blank" class="btn btn-outline-primary">
                                    <i class="fas fa-external-link-alt me-2"></i>在B站观看
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">正在加载视频详情...</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- 多视频列表显示 -->
<div class="row">
    <div class="col-lg-8">
        <div class="mb-4 video-list-container" id="videoList">
            {% if search_failed %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>搜索失败</strong><br>
                    无法从B站获取搜索结果，请检查网络连接或稍后重试。
                </div>
            {% elif videos %}
                {% for video in videos %}
                <div class="card mb-2 video-item animate-fade-in" data-video-id="{{ video.bvid }}" onclick="showVideoDetail(this, '{{ video.bvid }}')">
                    <div class="card-body p-3">
                        <h5 class="mb-2">{{ video.title }}</h5>
                        <div class="d-flex flex-wrap text-muted small mb-2">
                            <div class="me-3">
                                <i class="fas fa-user me-1" style="color: var(--primary-color);"></i> {{ video.author }}
                            </div>
                            <div class="me-3">
                                <i class="fas fa-play me-1" style="color: var(--primary-color);"></i> {{ video.play | default:"0" }}
                            </div>
                            <div class="me-3">
                                <i class="fas fa-thumbs-up me-1" style="color: var(--primary-color);"></i> {{ video.like | default:"0" }}
                            </div>
                            <div>
                                <i class="fas fa-calendar me-1" style="color: var(--primary-color);"></i> {{ video.pubdate | date:"Y-m-d" }}
                            </div>
                        </div>
                        <div class="d-flex">
                            <span class="badge bg-light text-dark me-2">视频</span>
                            <span class="badge bg-light text-dark">{{ video.duration | default:"未知时长" }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> 没有找到相关视频，请尝试其他关键词
                </div>
            {% endif %}
        </div>

        <!-- 分页 -->
        {% if videos and total_pages > 1 %}
        <nav aria-label="搜索结果分页">
            <ul class="pagination justify-content-center">
                {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{% url 'search_videos' %}?keyword={{ keyword }}&sort={{ sort_type }}&page={{ page|add:'-1' }}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
                {% endif %}

                {% if page_range %}
                    {% for p in page_range %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        <a class="page-link" href="{% url 'search_videos' %}?keyword={{ keyword }}&sort={{ sort_type }}&page={{ p }}">{{ p }}</a>
                    </li>
                    {% endfor %}
                {% else %}
                    <li class="page-item active">
                        <a class="page-link" href="#">{{ page }}</a>
                    </li>
                {% endif %}

                {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="{% url 'search_videos' %}?keyword={{ keyword }}&sort={{ sort_type }}&page={{ page|add:'1' }}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>

    <div class="col-lg-4">
        <div class="card border-0 shadow-sm detail-sidebar">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">视频详情</h5>
            </div>
            <div class="card-body" id="videoDetail">
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-tv fa-3x" style="color: var(--primary-color);"></i>
                    </div>
                    <h4 class="mb-3">点击左侧视频查看详细信息</h4>
                    <p class="text-muted">选择感兴趣的视频，查看详情并添加到课程列表</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // AI内容分析功能
    function performAIAnalysis() {
        const searchQuery = '{{ keyword|escapejs }}';
        const videos = {{ videos_json|safe }};

        // 显示加载状态
        const analysisAlert = document.querySelector('.alert-info');
        const originalContent = analysisAlert.innerHTML;

        analysisAlert.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                <div>
                    <strong>正在进行AI语义分析...</strong><br>
                    <small class="text-muted">请稍候，AI正在分析搜索内容的学习相关性</small>
                </div>
            </div>
        `;

        // 准备视频数据
        const videoResults = videos ? videos.slice(0, 3).map(video => ({
            title: video.title,
            author: video.author,
            desc: video.desc || '',
            zone: video.zone || video.tname || '',
            tname: video.tname || ''
        })) : [];

        // 发送AJAX请求
        fetch('{% url "ai_content_analysis" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: new URLSearchParams({
                'search_query': searchQuery,
                'video_results': JSON.stringify(videoResults)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 显示分析结果
                let alertClass = 'alert-info';
                let icon = 'fas fa-info-circle';
                let title = 'AI分析结果';

                if (data.is_learning_related === true) {
                    alertClass = 'alert-success';
                    icon = 'fas fa-check-circle';
                    title = '✅ 学习相关内容';
                } else if (data.is_learning_related === false) {
                    alertClass = 'alert-warning';
                    icon = 'fas fa-exclamation-triangle';
                    title = '⚠️ 可能非学习相关';
                }

                analysisAlert.className = `alert ${alertClass} alert-dismissible fade show`;
                analysisAlert.innerHTML = `
                    <div class="d-flex align-items-start">
                        <i class="${icon} me-3 mt-1"></i>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-2">${title}</h6>
                            <p class="mb-2">
                                <strong>置信度：</strong>${(data.confidence * 100).toFixed(1)}%<br>
                                <strong>分析结果：</strong>${data.reason}
                            </p>
                            <details class="mt-2">
                                <summary class="btn btn-sm btn-outline-secondary">查看完整AI回复</summary>
                                <div class="mt-2 p-2 bg-light rounded">
                                    <small><pre>${data.full_response}</pre></small>
                                </div>
                            </details>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
            } else {
                // 显示错误信息
                analysisAlert.className = 'alert alert-danger alert-dismissible fade show';
                analysisAlert.innerHTML = `
                    <div class="d-flex align-items-start">
                        <i class="fas fa-exclamation-circle me-3 mt-1"></i>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-2">AI分析失败</h6>
                            <p class="mb-0">${data.message}</p>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
            }
        })
        .catch(error => {
            console.error('AI分析请求失败:', error);
            analysisAlert.className = 'alert alert-danger alert-dismissible fade show';
            analysisAlert.innerHTML = `
                <div class="d-flex align-items-start">
                    <i class="fas fa-exclamation-circle me-3 mt-1"></i>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading mb-2">网络错误</h6>
                        <p class="mb-0">AI分析请求失败，请检查网络连接后重试</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
        });
    }

    // 显示视频详情
    function showVideoDetail(element, bvid) {
        // 添加选中样式
        $('.video-item').removeClass('active');
        $(element).addClass('active');
        
        // 显示加载中
        $('#videoDetail').html('<div class="text-center py-5"><div class="spinner-border" style="color: var(--primary-color);" role="status"></div><p class="mt-3">加载中...</p></div>');
        
        // 加载视频详情
        $.ajax({
            url: '/video/' + bvid + '/ajax/',
            type: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                console.log('AJAX响应:', response);
                if (response.success) {
                    // 创建详情HTML，包含添加到课程的功能
                    var detailHtml = response.html +
                        '<div class="mt-4">' +
                        '<form class="add-course-form" data-bvid="' + bvid + '">' +
                        '<input type="hidden" name="csrfmiddlewaretoken" value="' + $('[name=csrfmiddlewaretoken]').val() + '">' +
                        '<div class="mb-3">' +
                        '<label class="custom-label-large">' +
                        '<i class="fas fa-graduation-cap me-2 text-primary"></i>' +
                        '课程名称 (默认: <span class="text-primary">' + response.title + '</span>):' +
                        '</label>' +
                        '<div class="input-group">' +
                        '<span class="input-group-text bg-light">' +
                        '<i class="fas fa-book text-muted"></i>' +
                        '</span>' +
                        '<input type="text" class="form-control custom-textbox-large" name="custom_title" ' +
                        'placeholder="请输入课程名称" value="' + response.title + '" onfocus="this.select()">' +
                        '</div>' +
                        '</div>' +
                        '<button type="submit" class="btn btn-bili btn-lg w-100">' +
                        '<i class="fas fa-plus me-2"></i>添加到我的课程' +
                        '</button>' +
                        '</form>' +
                        '</div>';

                    $('#videoDetail').html(detailHtml);

                    // 格式化时长显示
                    setTimeout(function() {
                        formatAllDurations();
                    }, 100);

                    // 初始化tooltip
                    initializeTooltips();
                } else {
                    $('#videoDetail').html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i> ' + (response.message || '无法加载视频详情') + '</div>');
                }

                // 滚动到顶部
                $('.detail-sidebar').scrollTop(0);
            },
            error: function(xhr, status, error) {
                console.error('AJAX错误:', status, error);
                $('#videoDetail').html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i> 加载视频详情失败，请重试</div>');
            }
        });
    }
    
    // 加载单视频详情
    function loadSingleVideoDetail(bvid) {
        $.ajax({
            url: '/video/' + bvid + '/ajax/',
            type: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                console.log('单视频AJAX响应:', response);
                if (response.success) {
                    // 创建详情HTML，包含添加到课程的功能
                    var detailHtml = response.html +
                        '<div class="mt-4 border-top pt-4">' +
                        '<form class="add-course-form" data-bvid="' + bvid + '">' +
                        '<input type="hidden" name="csrfmiddlewaretoken" value="' + $('[name=csrfmiddlewaretoken]').val() + '">' +
                        '<div class="mb-3">' +
                        '<label class="custom-label-large">' +
                        '<i class="fas fa-graduation-cap me-2 text-primary"></i>' +
                        '课程名称 (默认: <span class="text-primary">' + response.title + '</span>):' +
                        '</label>' +
                        '<div class="input-group">' +
                        '<span class="input-group-text bg-light">' +
                        '<i class="fas fa-book text-muted"></i>' +
                        '</span>' +
                        '<input type="text" class="form-control custom-textbox-large" name="custom_title" ' +
                        'placeholder="请输入课程名称" value="' + response.title + '" onfocus="this.select()">' +
                        '</div>' +
                        '</div>' +
                        '<div class="d-grid gap-2">' +
                        '<button type="submit" class="btn btn-bili btn-lg">' +
                        '<i class="fas fa-plus me-2"></i>添加到我的课程' +
                        '</button>' +
                        '<a href="https://www.bilibili.com/video/' + bvid + '" target="_blank" class="btn btn-outline-primary btn-lg">' +
                        '<i class="fas fa-external-link-alt me-2"></i>在B站观看' +
                        '</a>' +
                        '</div>' +
                        '</form>' +
                        '</div>';

                    $('#singleVideoDetail').html(detailHtml);

                    // 初始化tooltip
                    initializeTooltips();
                } else {
                    $('#singleVideoDetail').html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i> ' + (response.message || '无法加载视频详情') + '</div>');
                }
            },
            error: function(xhr, status, error) {
                console.error('单视频AJAX错误:', status, error);
                $('#singleVideoDetail').html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i> 加载视频详情失败，请重试</div>');
            }
        });
    }

    // 格式化时长显示
    function formatDuration(seconds) {
        if (!seconds || seconds <= 0) return '时长未知';

        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;

        if (hours > 0) {
            return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        } else {
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
    }

    // 格式化页面中所有的时长显示
    function formatAllDurations() {
        $('.duration-text').each(function() {
            const $this = $(this);
            const originalText = $this.text().trim();

            // 检查是否包含"秒"字符
            if (originalText.includes('秒')) {
                const seconds = parseInt(originalText.replace('秒', '').trim());
                if (!isNaN(seconds) && seconds > 0) {
                    const formattedTime = formatDuration(seconds);
                    $this.text(formattedTime);
                }
            }
        });
    }

    // 页面加载完成后的处理
    $(document).ready(function() {
        {% if is_single_video %}
        // 单视频模式，内容已经在服务器端渲染，不需要AJAX加载
        console.log('单视频模式，内容已渲染');

        // 格式化分集时长显示
        formatAllDurations();
        {% else %}
        // 如果有视频列表，默认选中第一个
        if ($('.video-item').length > 0) {
            $('.video-item:first').click();
        }
        {% endif %}

        // 延迟格式化时长显示（确保DOM完全加载）
        setTimeout(function() {
            formatAllDurations();
        }, 100);

        // 清理标题中的HTML标签
        cleanupVideoTitles();
    });
    
    // 清理视频标题中的HTML标签
    function cleanupVideoTitles() {
        document.querySelectorAll('.video-item h5').forEach(function(element) {
            if (element.innerHTML.includes('<em class="keyword">') || element.innerHTML.includes('&lt;em class="keyword"&gt;')) {
                let content = element.innerHTML;
                // 替换所有HTML标签
                content = content.replace(/<em class="keyword">|<\/em>/g, '');
                content = content.replace(/&lt;em class="keyword"&gt;|&lt;\/em&gt;/g, '');
                element.innerHTML = content;
            }
        });
    }

    // 初始化tooltip
    function initializeTooltips() {
        // 销毁现有的tooltip
        $('[data-bs-toggle="tooltip"]').tooltip('dispose');

        // 重新初始化tooltip
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }

    // 处理添加课程表单提交
    $(document).on('submit', '.add-course-form', function(e) {
        e.preventDefault();

        const form = $(this);
        const bvid = form.data('bvid');
        const customTitle = form.find('input[name="custom_title"]').val();
        const csrfToken = form.find('input[name="csrfmiddlewaretoken"]').val();

        $.ajax({
            url: '/add_to_course/' + bvid + '/',
            type: 'POST',
            data: {
                'custom_title': customTitle,
                'csrfmiddlewaretoken': csrfToken
            },
            success: function(response) {
                if (response.success) {
                    if (response.created) {
                        // 新课程创建成功，显示学习计划弹窗
                        showStudyPlanModal(response);
                    } else {
                        // 课程已存在或标题更新
                        alert(response.message);
                    }
                } else {
                    alert('添加失败：' + response.message);
                }
            },
            error: function() {
                alert('网络错误，请稍后再试');
            }
        });
    });

    // 显示学习计划弹窗
    function showStudyPlanModal(courseData) {
        $('#planCourseTitle').text(courseData.course_title);
        $('#planTotalEpisodes').text(courseData.total_episodes);
        $('#planTotalDuration').text(courseData.total_duration_formatted);
        $('#planCourseId').val(courseData.course_id);

        $('#studyPlanModal').modal('show');
    }

    // 处理学习计划表单提交
    $(document).on('submit', '#studyPlanForm', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const courseTitle = $('#planCourseTitle').text();
        const courseId = $('#planCourseId').val();

        console.log('提交学习计划表单:', {
            courseTitle: courseTitle,
            courseId: courseId,
            formData: Object.fromEntries(formData)
        });

        $.ajax({
            url: '{% url "create_study_plan" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                console.log('学习计划创建响应:', response);
                if (response.success) {
                    $('#studyPlanModal').modal('hide');
                    // 等待模态框完全隐藏后再显示成功弹窗
                    setTimeout(function() {
                        showSuccessModal(courseTitle, courseId, response.plan_id);
                    }, 500);
                } else {
                    alert('创建计划失败：' + response.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX错误:', xhr, status, error);
                alert('网络错误，请稍后再试');
            }
        });
    });

    // 不设定计划按钮
    $(document).on('click', '#skipPlanBtn', function() {
        $('#studyPlanModal').modal('hide');
        alert('课程添加成功！您可以随时在"我的计划"中创建学习计划。');
    });

    // 显示成功弹窗
    function showSuccessModal(courseTitle, courseId, planId) {
        console.log('显示成功弹窗:', {courseTitle, courseId, planId});

        // 设置弹窗内容
        $('#successCourseTitle').text(courseTitle);
        $('#successCourseId').val(courseId);
        $('#successPlanId').val(planId);

        // 确保模态框存在
        if ($('#successModal').length === 0) {
            console.error('成功模态框不存在！');
            alert('恭喜！' + courseTitle + ' 的学习计划已成功创建！');
            return;
        }

        // 显示模态框
        try {
            // 兼容Bootstrap 4和5
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                // Bootstrap 5
                const modal = new bootstrap.Modal(document.getElementById('successModal'));
                modal.show();
            } else {
                // Bootstrap 4 或 jQuery
                $('#successModal').modal('show');
            }
            console.log('成功模态框已显示');
        } catch (error) {
            console.error('显示模态框失败:', error);
            alert('恭喜！' + courseTitle + ' 的学习计划已成功创建！');
        }
    }

    // 成功弹窗按钮事件
    $(document).on('click', '#continueSearchBtn', function() {
        $('#successModal').modal('hide');
        // 保持当前搜索结果界面
    });

    $(document).on('click', '#gotoCourseBtn', function() {
        const courseId = $('#successCourseId').val();
        window.location.href = '/course/' + courseId + '/';
    });

    $(document).on('click', '#gotoPlanBtn', function() {
        const planId = $('#successPlanId').val();
        window.location.href = '/plan/' + planId + '/';
    });

    // 搜索表单处理（搜索结果页面）
    $('#searchFormResults').on('submit', function(e) {
        e.preventDefault();

        const keyword = $('#searchInputResults').val().trim();
        const skipWarning = $('#skipWarningResults').val() === 'true';

        if (!keyword) {
            return;
        }

        // 如果已经跳过警告，直接提交
        if (skipWarning) {
            this.submit();
            return;
        }

        // 检查是否需要学习提醒
        $.ajax({
            url: '{% url "search_videos" %}',
            type: 'GET',
            data: {
                'keyword': keyword,
                'sort': $('input[name="sort"]').val(),
                'skip_warning': 'false'
            },
            success: function(response) {
                if (response.show_warning) {
                    // 显示学习提醒模态框
                    $('#learningReminderModal').modal('show');
                } else {
                    // 直接跳转到搜索结果页面
                    $('#searchFormResults')[0].submit();
                }
            },
            error: function() {
                // 如果检查失败，直接提交搜索
                $('#searchFormResults')[0].submit();
            }
        });
    });

    // 学习提醒模态框按钮处理（搜索结果页面）
    $('#dontCareBtnResults, #reallyLearningBtnResults').on('click', function() {
        const keyword = $('#searchInputResults').val().trim();
        const ignoreKeyword = $('#ignoreKeywordCheckResults').is(':checked');
        const disableAll = $('#disableAllCheckResults').is(':checked');

        // 处理用户偏好设置
        if (ignoreKeyword || disableAll) {
            const action = disableAll ? 'disable_all' : 'ignore_keyword';

            $.ajax({
                url: '{% url "update_learning_reminder" %}',
                type: 'POST',
                data: {
                    'action': action,
                    'keyword': keyword,
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        console.log(response.message);
                    }
                },
                error: function() {
                    console.log('偏好设置更新失败');
                }
            });
        }

        // 设置跳过警告标志
        $('#skipWarningResults').val('true');
        // 关闭模态框
        $('#learningReminderModal').modal('hide');

        // 不直接提交表单，保留搜索内容
        // 用户可以再次点击搜索按钮
    });

    // 页面加载完成后的初始化
    $(document).ready(function() {
        console.log('搜索结果页面已加载');
        console.log('学习计划模态框存在:', $('#studyPlanModal').length > 0);
        console.log('成功模态框存在:', $('#successModal').length > 0);

        // 测试模态框功能
        window.testSuccessModal = function() {
            showSuccessModal('测试课程', '1', '1');
        };

        console.log('可以在控制台运行 testSuccessModal() 来测试成功弹窗');
    });
</script>

<!-- 学习计划设定模态框 -->
<div class="modal fade" id="studyPlanModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-plus me-2"></i>制定学习计划
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>恭喜！</strong>课程已成功添加。现在为您的学习制定一个计划，让学习更有条理！
                </div>

                <!-- 课程信息 -->
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-video me-2 text-primary"></i>课程信息
                        </h6>
                        <div class="row">
                            <div class="col-md-4">
                                <strong>课程名称：</strong><br>
                                <span id="planCourseTitle" class="text-primary"></span>
                            </div>
                            <div class="col-md-4">
                                <strong>总分集数：</strong><br>
                                <span id="planTotalEpisodes"></span> 集
                            </div>
                            <div class="col-md-4">
                                <strong>总时长：</strong><br>
                                <span id="planTotalDuration"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 学习计划表单 -->
                <form id="studyPlanForm">
                    {% csrf_token %}
                    <input type="hidden" id="planCourseId" name="course_id">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="totalDays" class="form-label">
                                <i class="fas fa-calendar me-1 text-primary"></i>计划学习总天数
                            </label>
                            <input type="number" class="form-control" id="totalDays" name="total_days"
                                   min="1" max="365" value="30" required>
                            <div class="form-text">建议根据课程内容和个人时间安排</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dailyMinutes" class="form-label">
                                <i class="fas fa-clock me-1 text-primary"></i>每天学习时间（分钟）
                            </label>
                            <input type="number" class="form-control" id="dailyMinutes" name="daily_minutes"
                                   min="10" max="480" value="60" required>
                            <div class="form-text">建议每天30-120分钟</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="focusModules" class="form-label">
                            <i class="fas fa-star me-1 text-warning"></i>重点学习模块（可选）
                        </label>
                        <textarea class="form-control" id="focusModules" name="focus_modules" rows="3"
                                  placeholder="例如：基本概念、实战项目、高级特性等"></textarea>
                        <div class="form-text">描述您想重点关注的学习内容</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="skipPlanBtn">
                    <i class="fas fa-heart me-1"></i>不设定计划，随心学
                </button>
                <button type="submit" form="studyPlanForm" class="btn btn-primary">
                    <i class="fas fa-check me-1"></i>创建学习计划
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 成功提示模态框 -->
<div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>学习计划创建成功！
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-graduation-cap fa-3x text-success mb-3"></i>
                    <h4>恭喜！</h4>
                    <p class="mb-0">
                        <strong id="successCourseTitle"></strong> 的学习计划已成功创建！
                    </p>
                </div>

                <input type="hidden" id="successCourseId">
                <input type="hidden" id="successPlanId">

                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" id="continueSearchBtn">
                        <i class="fas fa-search me-2"></i>继续搜索课程
                    </button>
                    <button type="button" class="btn btn-primary" id="gotoCourseBtn">
                        <i class="fas fa-play me-2"></i>进入该课程详情
                    </button>
                    <button type="button" class="btn btn-success" id="gotoPlanBtn">
                        <i class="fas fa-calendar-check me-2"></i>查看我创建的计划
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 学习提醒模态框 -->
<div class="modal fade" id="learningReminderModal" tabindex="-1" aria-labelledby="learningReminderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="learningReminderModalLabel">
                    <i class="fas fa-graduation-cap me-2"></i>学习提醒
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <i class="fas fa-book-open fa-3x text-warning mb-3"></i>
                    <h4 class="text-primary">你最好是在学习</h4>
                    <p class="text-muted">
                        检测到您搜索的内容可能与学习无关。<br>
                        这是一个学习平台，建议您搜索学习相关的内容哦～
                    </p>
                </div>
                <div class="alert alert-light">
                    <small class="text-muted">
                        <i class="fas fa-lightbulb me-1"></i>
                        建议搜索：编程教程、数学课程、英语学习、技能培训等
                    </small>
                </div>

                <!-- 用户偏好选项 -->
                <div class="mt-3">
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="ignoreKeywordCheckResults">
                        <label class="form-check-label small text-muted" for="ignoreKeywordCheckResults">
                            以后搜索同样的内容都不要管我了！
                        </label>
                    </div>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input" type="checkbox" id="disableAllCheckResults">
                        <label class="form-check-label small text-muted" for="disableAllCheckResults">
                            以后我不管搜什么内容都不要管我了
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-outline-secondary" id="dontCareBtnResults">
                    <i class="fas fa-meh me-1"></i>少管我
                </button>
                <button type="button" class="btn btn-primary" id="reallyLearningBtnResults">
                    <i class="fas fa-heart me-1"></i>我真的在学习
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}