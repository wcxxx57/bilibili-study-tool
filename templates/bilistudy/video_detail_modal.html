{% load custom_filters %}

<div class="row">
    <div class="col-md-4">
        <img src="{{ video.cover }}" alt="{{ video.title }}" class="img-fluid rounded">
    </div>
    <div class="col-md-8">
        <h5 class="mb-3">{{ video.title }}</h5>
        <div class="video-info">
            <div class="video-meta mb-2">
                <i class="fas fa-user me-2"></i> UP主: <strong>{{ video.author }}</strong>
            </div>
            <div class="video-meta mb-2">
                <i class="fas fa-calendar me-2"></i> 发布日期: <strong>{{ video.pub_date|date:"Y-m-d" }}</strong>
            </div>
            <div class="video-meta mb-2">
                <i class="fas fa-play me-2"></i> 播放量: <strong>{{ video.play_count }}</strong>
            </div>
            <div class="video-meta mb-2">
                <i class="fas fa-thumbs-up me-2"></i> 点赞数: <strong>{{ video.like_count }}</strong>
            </div>
            {% if episodes.count > 1 %}
            <div class="video-meta mb-2">
                <i class="fas fa-list-ol me-2"></i> 分集数: <strong>{{ episodes.count }}</strong>
            </div>
            {% endif %}

            <!-- B站跳转按钮 -->
            <div class="video-meta mb-3">
                <a href="https://www.bilibili.com/video/{{ video.bvid }}" target="_blank" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-external-link-alt me-1"></i> 在B站观看
                </a>
            </div>

            {% if is_in_course_list %}
            <div class="alert alert-success mt-3">
                <i class="fas fa-check-circle me-2"></i> 此视频已在您的课程列表中
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if episodes and episodes.count > 0 %}
<div class="mt-4">
    <h6 class="mb-3"><i class="fas fa-list me-2"></i> 视频分集
        <span class="badge bg-secondary ms-2">共{{ episodes.count }}集</span>
    </h6>
    <div class="episode-list border rounded p-2" style="max-height: 250px; overflow-y: auto; background-color: #f8f9fa;">
        {% for episode in episodes %}
        <div class="episode-item d-flex align-items-center p-2 mb-2 bg-white border rounded shadow-sm hover-shadow">
            <div class="episode-number me-3">
                <span class="badge bg-primary fs-6">P{{ episode.order }}</span>
            </div>
            <div class="episode-info flex-grow-1">
                <div class="episode-title text-dark mb-1" style="font-size: 0.9rem; font-weight: 500;">
                    {{ episode.title|truncatechars:35 }}
                </div>
                <div class="episode-duration text-muted small">
                    <i class="fas fa-clock me-1"></i>
                    {% if episode.duration %}
                        <span class="duration-text">{{ episode.duration }}秒</span>
                    {% else %}
                        <span class="text-muted">时长未知</span>
                    {% endif %}
                </div>
            </div>
            <div class="episode-actions">
                <a href="https://www.bilibili.com/video/{{ video.bvid }}?p={{ episode.order }}"
                   target="_blank" class="btn btn-sm btn-outline-primary btn-hover">
                    <i class="fas fa-play me-1"></i>播放
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
.episode-item {
    transition: all 0.2s ease;
}

.episode-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
}

.hover-shadow {
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.btn-hover {
    transition: all 0.2s ease;
}

.btn-hover:hover {
    transform: scale(1.05);
}

.episode-title {
    line-height: 1.3;
}

.badge.fs-6 {
    font-size: 0.8rem !important;
    padding: 0.4em 0.6em;
}

.episode-list {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e0 #f7fafc;
}

.episode-list::-webkit-scrollbar {
    width: 6px;
}

.episode-list::-webkit-scrollbar-track {
    background: #f7fafc;
    border-radius: 3px;
}

.episode-list::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 3px;
}

.episode-list::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}
</style>

<script>
// 格式化时长显示
function formatDuration(seconds) {
    if (!seconds || seconds <= 0) return '时长未知';

    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;

    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

// 格式化页面中所有的时长显示
function formatAllDurations() {
    $('.duration-text').each(function() {
        const $this = $(this);
        const originalText = $this.text().trim();

        // 检查是否包含"秒"字符
        if (originalText.includes('秒')) {
            const seconds = parseInt(originalText.replace('秒', '').trim());
            if (!isNaN(seconds) && seconds > 0) {
                const formattedTime = formatDuration(seconds);
                $this.text(formattedTime);
            }
        }
    });
}

// 页面加载完成后格式化时长
$(document).ready(function() {
    setTimeout(function() {
        formatAllDurations();
    }, 100);
});
</script>
{% endif %}

{% if video.description %}
<div class="mt-4">
    <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i> 视频简介</h6>
    <div class="bg-light p-3 rounded" style="max-height: 150px; overflow-y: auto;">
        <p class="mb-0" style="white-space: pre-line;">{{ video.description }}</p>
    </div>
</div>
{% endif %} 