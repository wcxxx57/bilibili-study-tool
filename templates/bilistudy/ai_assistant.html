{% extends 'bilistudy/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'bilistudy/css/custom-styles.css' %}">
<style>
/* AIæ¨¡å‹é€‰æ‹©å™¨è‡ªå®šä¹‰æ ·å¼ - æ·¡é›…é…è‰² */
.btn-gemini {
    background: transparent;
    border: 2px solid #e8eaed;
    color: #5f6368;
    position: relative;
    transition: all 0.3s ease;
}

.btn-gemini:hover,
.btn-check:checked + .btn-gemini {
    background: linear-gradient(135deg, rgba(66, 133, 244, 0.1) 0%, rgba(52, 168, 83, 0.1) 50%, rgba(234, 67, 53, 0.1) 100%);
    border-color: rgba(66, 133, 244, 0.3);
    color: #4285f4 !important;
    box-shadow: 0 2px 8px rgba(66, 133, 244, 0.1);
}

.btn-gemini:hover .text-muted,
.btn-check:checked + .btn-gemini .text-muted {
    color: rgba(95, 99, 104, 0.8) !important;
}

.btn-deepseek {
    background: transparent;
    border: 2px solid #e8eaed;
    color: #5f6368;
    position: relative;
    transition: all 0.3s ease;
}

.btn-deepseek:hover,
.btn-check:checked + .btn-deepseek {
    background: rgba(74, 144, 226, 0.1);
    border-color: rgba(74, 144, 226, 0.3);
    color: #4a90e2 !important;
    box-shadow: 0 2px 8px rgba(74, 144, 226, 0.1);
}

.btn-deepseek:hover .text-muted,
.btn-check:checked + .btn-deepseek .text-muted {
    color: rgba(95, 99, 104, 0.8) !important;
}

/* æ·±è‰²ä¸»é¢˜ä¸‹çš„AIæ¨¡å‹é€‰æ‹©å™¨æ ·å¼ */
[data-theme="dark"] .btn-gemini {
    background: transparent;
    border: 2px solid #334155;
    color: #e2e8f0;
}

[data-theme="dark"] .btn-gemini:hover,
[data-theme="dark"] .btn-check:checked + .btn-gemini {
    background: linear-gradient(135deg, rgba(66, 133, 244, 0.2) 0%, rgba(52, 168, 83, 0.2) 50%, rgba(234, 67, 53, 0.2) 100%);
    border-color: rgba(66, 133, 244, 0.5);
    color: #60a5fa !important;
    box-shadow: 0 4px 15px rgba(66, 133, 244, 0.2);
}

[data-theme="dark"] .btn-gemini:hover .text-muted,
[data-theme="dark"] .btn-check:checked + .btn-gemini .text-muted {
    color: #94a3b8 !important;
}

[data-theme="dark"] .btn-deepseek {
    background: transparent;
    border: 2px solid #334155;
    color: #e2e8f0;
}

[data-theme="dark"] .btn-deepseek:hover,
[data-theme="dark"] .btn-check:checked + .btn-deepseek {
    background: rgba(59, 130, 246, 0.2);
    border-color: rgba(59, 130, 246, 0.5);
    color: #60a5fa !important;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
}

[data-theme="dark"] .btn-deepseek:hover .text-muted,
[data-theme="dark"] .btn-check:checked + .btn-deepseek .text-muted {
    color: #94a3b8 !important;
}

/* æ¨¡å‹é€‰æ‹©å™¨å®¹å™¨æ ·å¼ */
.model-selector {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 2px solid #dee2e6;
}

[data-theme="dark"] .model-selector {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-bottom: 2px solid #475569;
}

/* å›¾æ ‡ç®€å•åŠ¨ç”»æ•ˆæœ */
.btn-gemini i,
.btn-deepseek i {
    transition: transform 0.2s ease;
}

.btn-gemini:hover i,
.btn-check:checked + .btn-gemini i,
.btn-deepseek:hover i,
.btn-check:checked + .btn-deepseek i {
    transform: scale(1.05);
}

/* æŒ‰é’®ç»„æ•´ä½“æ ·å¼ */
.btn-group .btn {
    flex: 1;
    min-height: 80px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}

.btn-group .btn strong {
    font-size: 1.1rem;
    margin-bottom: 2px;
}

.btn-group .btn small {
    font-size: 0.8rem;
    line-height: 1.2;
}

.chat-container {
    height: 520px;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    background: #fafafa;
}

.chat-messages {
    height: 420px;
    overflow-y: auto;
    padding: 20px;
    background: white;
    border-radius: 10px 10px 0 0;
}

/* æ·±è‰²ä¸»é¢˜ä¸‹çš„èŠå¤©å®¹å™¨ */
[data-theme="dark"] .chat-container {
    border: 1px solid #334155;
    background: #1e293b;
}

[data-theme="dark"] .chat-messages {
    background: #0f1419;
    color: #e2e8f0;
}

.message {
    margin-bottom: 8px;
    animation: fadeIn 0.3s ease-in;
}

.message.user {
    text-align: right;
}

.message.ai {
    text-align: left;
}

.message-bubble {
    display: inline-block;
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
}

.message.user .message-bubble {
    background: #007bff;
    color: white;
    border-bottom-right-radius: 4px;
}

.message.ai .message-bubble {
    background: #f1f3f4;
    color: #333;
    border-bottom-left-radius: 4px;
}

.chat-input-area {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 0 0 10px 10px;
    border-top: 1px solid #e0e0e0;
}

/* æ·±è‰²ä¸»é¢˜ä¸‹çš„æ¶ˆæ¯æ°”æ³¡ */
[data-theme="dark"] .message.user .message-bubble {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: #ffffff;
}

[data-theme="dark"] .message.ai .message-bubble {
    background: #334155;
    color: #e2e8f0;
    border: 1px solid #475569;
}

[data-theme="dark"] .chat-input-area {
    background: #1e293b;
    border-top: 1px solid #334155;
}

.quick-actions {
    margin-bottom: 20px;
}

.quick-action-btn {
    margin: 5px;
    border-radius: 20px;
    transition: all 0.3s ease;
}

.quick-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.typing-indicator {
    display: none;
    text-align: left;
}

.typing-indicator .message-bubble {
    background: #f1f3f4;
    color: #666;
}

/* æ·±è‰²ä¸»é¢˜ä¸‹çš„å¿«é€Ÿæ“ä½œå’Œæ‰“å­—æŒ‡ç¤ºå™¨ */
[data-theme="dark"] .quick-action-btn {
    background: #334155;
    border-color: #475569;
    color: #e2e8f0;
}

[data-theme="dark"] .quick-action-btn:hover {
    background: #3b82f6;
    border-color: #3b82f6;
    color: #ffffff;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

[data-theme="dark"] .typing-indicator .message-bubble {
    background: #334155;
    color: #94a3b8;
    border: 1px solid #475569;
}

[data-theme="dark"] .typing-dots span {
    background-color: #64748b;
}

.typing-dots {
    display: inline-block;
}

.typing-dots span {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #999;
    margin: 0 2px;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.course-card {
    transition: transform 0.2s ease;
    cursor: pointer;
}

.course-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.ai-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    margin-right: 10px;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #007bff;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    margin-left: 10px;
}

/* Markdownæ¸²æŸ“æ ·å¼ */
.message-bubble h3,
.message-bubble h4,
.message-bubble h5 {
    font-weight: 600;
    margin-top: 12px;
    margin-bottom: 8px;
    line-height: 1.3;
}

.message-bubble h3 {
    font-size: 1.1em;
    border-bottom: 2px solid #007bff;
    padding-bottom: 4px;
}

.message-bubble h4 {
    font-size: 1.05em;
}

.message-bubble h5 {
    font-size: 1em;
}



.message-bubble strong {
    font-weight: 600;
    color: #2c3e50;
}

.message-bubble em {
    font-style: italic;
    color: inherit;
}

.message-bubble code {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.85em;
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid #e9ecef;
}

.message-bubble pre {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.85em;
    line-height: 1.4;
    overflow-x: auto;
    border: 1px solid #495057;
}

.message-bubble pre code {
    background: none !important;
    border: none !important;
    padding: 0 !important;
    color: inherit;
}

.message-bubble ul {
    margin: 8px 0;
    padding-left: 20px;
}

.message-bubble li {
    margin: 2px 0;
    list-style-type: disc;
    line-height: 1.4;
}

.message-bubble p {
    margin: 3px 0;
    line-height: 1.4;
}

.message-bubble a {
    color: #007bff;
    transition: color 0.2s ease;
}

.message-bubble a:hover {
    color: #0056b3;
    text-decoration: none;
}

/* AIå›å¤ä¸­çš„åˆ—è¡¨æ ·å¼ */
.message-bubble ul,
.message-bubble ol {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
}

.message-bubble ul li {
    list-style-type: disc;
    margin-bottom: 0.25rem;
    line-height: 1.5;
}

.message-bubble ol li {
    list-style-type: decimal;
    margin-bottom: 0.25rem;
    line-height: 1.5;
}

.message-bubble li {
    color: #333;
}

/* åµŒå¥—åˆ—è¡¨æ ·å¼ */
.message-bubble ul ul,
.message-bubble ol ol,
.message-bubble ul ol,
.message-bubble ol ul {
    margin: 0.25rem 0;
    padding-left: 1.2rem;
}

.message-bubble ul ul li {
    list-style-type: circle;
}

.message-bubble ul ul ul li {
    list-style-type: square;
}

/* å…¨å±å¯¹è¯æ¨¡å¼æ ·å¼ */
.chat-messages-fullscreen {
    max-height: none;
    height: 100%;
}

.chat-messages-fullscreen .message {
    margin-bottom: 1rem;
}

.chat-messages-fullscreen .message-bubble {
    max-width: 70%;
    font-size: 1.1rem;
    line-height: 1.6;
    padding: 1rem 1.25rem;
}

.chat-messages-fullscreen .ai-avatar,
.chat-messages-fullscreen .user-avatar {
    width: 45px;
    height: 45px;
    font-size: 1.1rem;
}

/* å…¨å±æ¨¡å¼æŒ‰é’®æ ·å¼ */
#fullscreenChatBtn {
    transition: all 0.3s ease;
}

#fullscreenChatBtn:hover {
    transform: scale(1.05);
}

/* å…¨å±æ¨¡æ€æ¡†æ ·å¼ä¼˜åŒ– */
.modal-fullscreen .modal-content {
    border-radius: 0;
}

.modal-fullscreen .modal-header {
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    padding: 1rem 1.5rem;
}

/* å…¨å±æ¨¡å¼AIæ¨¡å‹é€‰æ‹©å™¨ - ç®€æ´ç‰ˆ */
.model-selector-fullscreen .btn-model-simple {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: rgba(255, 255, 255, 0.9);
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    font-weight: 500;
    border-radius: 8px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    min-width: 90px;
    justify-content: center;
}

.model-selector-fullscreen .btn-model-simple:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.5);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.model-selector-fullscreen .btn-check:checked + .btn-model-simple {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.7);
    color: white;
    box-shadow: 0 0 12px rgba(255, 255, 255, 0.2);
}

.model-selector-fullscreen .btn-model-simple i {
    font-size: 0.9rem;
}

.model-selector-fullscreen .btn-model-simple span {
    font-size: 0.85rem;
}

/* å…¨å±å¿«é€Ÿæ“ä½œæ æ ·å¼ */
.fullscreen-quick-actions {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #dee2e6;
}

.fullscreen-quick-actions .btn {
    border-radius: 20px;
    font-size: 0.85rem;
    padding: 0.4rem 0.8rem;
    transition: all 0.3s ease;
}

.fullscreen-quick-actions .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.fullscreen-quick-actions .btn-outline-primary:hover {
    background: linear-gradient(135deg, #007bff, #0056b3);
}

.fullscreen-quick-actions .btn-outline-success:hover {
    background: linear-gradient(135deg, #28a745, #1e7e34);
}

.fullscreen-quick-actions .btn-outline-info:hover {
    background: linear-gradient(135deg, #17a2b8, #117a8b);
}

.fullscreen-quick-actions .btn-outline-warning:hover {
    background: linear-gradient(135deg, #ffc107, #e0a800);
}
</style>
{% endblock %}

{% block title %}AIå­¦ä¹ åŠ©æ‰‹{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex align-items-center">
                <div class="ai-avatar me-3">
                    <i class="fas fa-robot"></i>
                </div>
                <div>
                    <h2 class="mb-1">AIå­¦ä¹ åŠ©æ‰‹</h2>
                    <p class="text-muted mb-0">æ“…é•¿å­¦ä¹ è¾…å¯¼çš„google geminiæ¨¡å‹/æ›´é€‚åˆä¸­å›½å®å®ä½“è´¨çš„deepseekæ¨¡å‹ï¼Œä¸ºæ‚¨æä¾›ä¸ªæ€§åŒ–å­¦ä¹ å»ºè®®å’Œè¾…å¯¼</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- å·¦ä¾§ï¼šèŠå¤©ç•Œé¢ -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-comments me-2 text-primary"></i>æ™ºèƒ½å¯¹è¯
                    </h5>
                    <button class="btn btn-outline-primary btn-sm" id="fullscreenChatBtn" title="å…¨å±å¯¹è¯">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <!-- AIæ¨¡å‹é€‰æ‹©å™¨ -->
                    <div class="model-selector p-3 border-bottom bg-light">
                        <h6 class="mb-2">
                            <i class="fas fa-robot me-2"></i>é€‰æ‹©AIæ¨¡å‹ï¼š
                        </h6>
                        <div class="btn-group w-100" role="group" aria-label="AIæ¨¡å‹é€‰æ‹©">
                            <input type="radio" class="btn-check" name="aiModel" id="gemini" value="gemini" checked>
                            <label class="btn btn-gemini" for="gemini">
                                <i class="fab fa-google me-1"></i>
                                <strong>Gemini</strong>
                                <small class="d-block text-muted">å­¦ä¹ è®¡åˆ’Â·æ–¹æ³•æŒ‡å¯¼</small>
                            </label>

                            <input type="radio" class="btn-check" name="aiModel" id="deepseek" value="deepseek">
                            <label class="btn btn-deepseek" for="deepseek">
                                <i class="fas fa-brain me-1"></i>
                                <strong>DeepSeek</strong>
                                <small class="d-block text-muted">è”ç½‘æœç´¢Â·è§†é¢‘æ¨è</small>
                            </label>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted" id="modelDescription">
                                <i class="fas fa-info-circle me-1"></i>
                                <span id="modelDescText">Geminiï¼šæ“…é•¿åˆ¶å®šå­¦ä¹ è®¡åˆ’å’Œå­¦ä¹ æ–¹æ³•æŒ‡å¯¼</span>
                            </small>
                        </div>
                    </div>

                    <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
                    <div class="quick-actions p-3 border-bottom">
                        <h6 class="mb-2">å¿«é€Ÿå¼€å§‹ï¼š</h6>
                        <button class="btn btn-outline-primary btn-sm quick-action-btn" data-action="study_plan">
                            <i class="fas fa-calendar-alt me-1"></i>åˆ¶å®šå­¦ä¹ è®¡åˆ’
                        </button>
                        <button class="btn btn-outline-success btn-sm quick-action-btn" data-action="progress_analysis">
                            <i class="fas fa-chart-line me-1"></i>åˆ†æå­¦ä¹ è¿›åº¦
                        </button>
                        <button class="btn btn-outline-info btn-sm quick-action-btn" data-action="study_tips">
                            <i class="fas fa-lightbulb me-1"></i>å­¦ä¹ æ–¹æ³•å»ºè®®
                        </button>
                        <button class="btn btn-outline-warning btn-sm quick-action-btn" data-action="motivation">
                            <i class="fas fa-fire me-1"></i>å­¦ä¹ åŠ¨æœºæ¿€åŠ±
                        </button>
                    </div>

                    <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai" id="welcomeMessage">
                            <div class="d-flex align-items-start">
                                <div class="ai-avatar">AI</div>
                                <div class="message-bubble" id="welcomeContent">
                                    ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIå­¦ä¹ åŠ©æ‰‹ï¼Œå½“å‰ä½¿ç”¨ <strong>Google Gemini</strong> æ¨¡å‹ã€‚<br><br>
                                    æˆ‘å¯ä»¥å¸®æ‚¨ï¼š<br>
                                    ğŸ“š åˆ¶å®šä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’<br>
                                    ğŸ“Š åˆ†æå­¦ä¹ è¿›åº¦å’Œæ•ˆæœ<br>
                                    ğŸ’¡ æä¾›å­¦ä¹ æ–¹æ³•å»ºè®®<br>
                                    ğŸ¯ è§£ç­”å­¦ä¹ ç›¸å…³é—®é¢˜<br><br>
                                    è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Œæˆ–è€…ç‚¹å‡»ä¸Šæ–¹çš„å¿«é€Ÿæ“ä½œæŒ‰é’®å¼€å§‹ï¼
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ‰“å­—æŒ‡ç¤ºå™¨ -->
                    <div class="typing-indicator message ai" id="typingIndicator">
                        <div class="d-flex align-items-start">
                            <div class="ai-avatar">AI</div>
                            <div class="message-bubble">
                                <div class="typing-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                                æ­£åœ¨æ€è€ƒä¸­...
                            </div>
                        </div>
                    </div>

                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="chat-input-area">
                        <form id="chatForm">
                            {% csrf_token %}
                            <div class="input-group">
                                <input type="text" class="form-control" id="messageInput"
                                       placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." maxlength="500">
                                <input type="hidden" id="chatType" value="general">
                                <input type="hidden" id="courseId" value="">
                                <input type="hidden" id="aiModel" value="gemini">
                                <button class="btn btn-primary" type="submit" id="sendButton">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            <small class="text-muted">æŒ‰Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ</small>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šè¯¾ç¨‹ä¿¡æ¯å’Œç»Ÿè®¡ -->
        <div class="col-lg-4">
            <!-- å­¦ä¹ ç»Ÿè®¡ -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2 text-success"></i>å­¦ä¹ ç»Ÿè®¡
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="mb-2">
                                <i class="fas fa-book fa-2x text-primary"></i>
                            </div>
                            <h5 class="mb-1">{{ user_courses|length }}</h5>
                            <small class="text-muted">æ€»è¯¾ç¨‹</small>
                        </div>
                        <div class="col-4">
                            <div class="mb-2">
                                <i class="fas fa-check-circle fa-2x text-success"></i>
                            </div>
                            <h5 class="mb-1">{{ recent_progress|length }}</h5>
                            <small class="text-muted">æœ€è¿‘å®Œæˆ</small>
                        </div>
                        <div class="col-4">
                            <div class="mb-2">
                                <i class="fas fa-clock fa-2x text-warning"></i>
                            </div>
                            <h5 class="mb-1">{{ total_study_minutes }}åˆ†é’Ÿ</h5>
                            <small class="text-muted">å­¦ä¹ æ—¶é•¿</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æœ€è¿‘è¯¾ç¨‹ -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-clock me-2 text-info"></i>æœ€è¿‘è¯¾ç¨‹
                    </h6>
                </div>
                <div class="card-body">
                    {% if user_courses %}
                        {% for course in user_courses %}
                        <div class="course-card p-2 mb-2 border rounded" 
                             data-course-id="{{ course.id }}"
                             onclick="selectCourse({{ course.id }}, '{{ course.custom_title|default:course.video.title|escapejs }}')">
                            <div class="d-flex align-items-center">
                                <img src="{{ course.video.cover }}" alt="è¯¾ç¨‹å°é¢" 
                                     class="rounded me-2" style="width: 40px; height: 30px; object-fit: cover;">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 small">{{ course.custom_title|default:course.video.title|truncatechars:20 }}</h6>
                                    <small class="text-muted">{{ course.video.author }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center">
                            <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                            æš‚æ— è¯¾ç¨‹<br>
                            <a href="{% url 'index' %}" class="btn btn-sm btn-outline-primary mt-2">
                                å»æ·»åŠ è¯¾ç¨‹
                            </a>
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å…¨å±AIå¯¹è¯æ¨¡æ€æ¡† -->
<div class="modal fade" id="fullscreenChatModal" tabindex="-1" aria-labelledby="fullscreenChatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="fullscreenChatModalLabel">
                    <i class="fas fa-robot me-2"></i>AIå­¦ä¹ åŠ©æ‰‹ - å…¨å±å¯¹è¯
                </h5>
                <div class="d-flex align-items-center">
                    <!-- AIæ¨¡å‹åˆ‡æ¢å™¨ - ç®€æ´ç‰ˆ -->
                    <div class="model-selector-fullscreen me-3">
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="fullscreenAiModel" id="fullscreenGemini" value="gemini" checked>
                            <label class="btn btn-model-simple" for="fullscreenGemini">
                                <i class="fab fa-google me-1"></i>
                                <span>Gemini</span>
                            </label>

                            <input type="radio" class="btn-check" name="fullscreenAiModel" id="fullscreenDeepseek" value="deepseek">
                            <label class="btn btn-model-simple" for="fullscreenDeepseek">
                                <i class="fas fa-brain me-1"></i>
                                <span>DeepSeek</span>
                            </label>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>

            <!-- å…¨å±æ¨¡å¼å¿«é€Ÿæ“ä½œæ  -->
            <div class="fullscreen-quick-actions bg-light border-bottom">
                <div class="container-fluid">
                    <div class="d-flex align-items-center py-2">
                        <span class="text-muted me-3 small">å¿«é€Ÿå¼€å§‹ï¼š</span>
                        <button class="btn btn-outline-primary btn-sm me-2 fullscreen-quick-action-btn" data-action="study_plan">
                            <i class="fas fa-calendar-alt me-1"></i>åˆ¶å®šå­¦ä¹ è®¡åˆ’
                        </button>
                        <button class="btn btn-outline-success btn-sm me-2 fullscreen-quick-action-btn" data-action="progress_analysis">
                            <i class="fas fa-chart-line me-1"></i>åˆ†æå­¦ä¹ è¿›åº¦
                        </button>
                        <button class="btn btn-outline-info btn-sm me-2 fullscreen-quick-action-btn" data-action="study_tips">
                            <i class="fas fa-lightbulb me-1"></i>å­¦ä¹ æ–¹æ³•å»ºè®®
                        </button>
                        <button class="btn btn-outline-warning btn-sm fullscreen-quick-action-btn" data-action="motivation">
                            <i class="fas fa-fire me-1"></i>å­¦ä¹ åŠ¨æœºæ¿€åŠ±
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-body p-0 d-flex flex-column" style="height: calc(100vh - 180px);">
                <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
                <div class="flex-grow-1 p-3" style="overflow-y: auto; background-color: #f8f9fa;">
                    <div class="chat-messages-fullscreen" id="chatMessagesFullscreen">
                        <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>

                    <!-- å…¨å±æ‰“å­—æŒ‡ç¤ºå™¨ -->
                    <div class="typing-indicator message ai" id="typingIndicatorFullscreen" style="display: none;">
                        <div class="d-flex align-items-start">
                            <div class="ai-avatar">AI</div>
                            <div class="message-bubble">
                                <div class="typing-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                                æ­£åœ¨æ€è€ƒä¸­...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="border-top bg-white p-3">
                    <form id="fullscreenChatForm">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" class="form-control form-control-lg" id="fullscreenMessageInput"
                                   placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." maxlength="500">
                            <input type="hidden" id="fullscreenChatType" value="general">
                            <input type="hidden" id="fullscreenCourseId" value="">
                            <input type="hidden" id="fullscreenAiModelValue" value="gemini">
                            <button class="btn btn-primary btn-lg" type="submit" id="fullscreenSendButton">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <small class="text-muted">æŒ‰Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ</small>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let selectedCourseId = '';
    let selectedCourseName = '';
    let isFullscreenMode = false;

    // AIæ¨¡å‹åˆ‡æ¢äº‹ä»¶
    $('input[name="aiModel"]').change(function() {
        const selectedModel = $(this).val();
        $('#aiModel').val(selectedModel);

        // æ›´æ–°æ¨¡å‹æè¿°
        const descriptions = {
            'gemini': 'Geminiï¼šæ“…é•¿åˆ¶å®šå­¦ä¹ è®¡åˆ’å’Œå­¦ä¹ æ–¹æ³•æŒ‡å¯¼',
            'deepseek': 'DeepSeekï¼šèƒ½å¤Ÿè”ç½‘æœç´¢ï¼Œæ¨èBç«™è§†é¢‘å’ŒUPä¸»'
        };
        $('#modelDescText').text(descriptions[selectedModel]);

        // æ›´æ–°æ¬¢è¿æ¶ˆæ¯
        updateWelcomeMessage(selectedModel);

        // æ·»åŠ æ¨¡å‹åˆ‡æ¢æç¤º
        const modelNames = {
            'gemini': 'Google Gemini',
            'deepseek': 'DeepSeek'
        };
        addMessage(`å·²åˆ‡æ¢åˆ° ${modelNames[selectedModel]} æ¨¡å‹`, 'system');
    });

    // æ›´æ–°æ¬¢è¿æ¶ˆæ¯å‡½æ•°
    function updateWelcomeMessage(model) {
        const welcomeMessages = {
            'gemini': `ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIå­¦ä¹ åŠ©æ‰‹ï¼Œå½“å‰ä½¿ç”¨ <strong>Google Gemini</strong> æ¨¡å‹ã€‚ï¼ˆå¦‚æœå’Œæˆ‘å¯¹è¯æ—¶é‡åˆ°ç½‘ç»œé—®é¢˜ï¼Œå¯ä»¥å…ˆæ£€æŸ¥ä¸€ä¸‹æ˜¯å¦ç§‘å­¦ä¸Šç½‘å“¦ï¼‰<br><br>
                æˆ‘å¯ä»¥å¸®æ‚¨ï¼š<br>
                ğŸ“š åˆ¶å®šä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’<br>
                ğŸ“Š åˆ†æå­¦ä¹ è¿›åº¦å’Œæ•ˆæœ<br>
                ğŸ’¡ æä¾›å­¦ä¹ æ–¹æ³•å»ºè®®<br>
                ğŸ¯ è§£ç­”å­¦ä¹ ç›¸å…³é—®é¢˜<br><br>
                è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Œæˆ–è€…ç‚¹å‡»ä¸Šæ–¹çš„å¿«é€Ÿæ“ä½œæŒ‰é’®å¼€å§‹ï¼`,
            'deepseek': `ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIå­¦ä¹ åŠ©æ‰‹ï¼Œå½“å‰ä½¿ç”¨ <strong>DeepSeek</strong> æ¨¡å‹ã€‚<br><br>
                æˆ‘å¯ä»¥å¸®æ‚¨ï¼š<br>
                ğŸ” è”ç½‘æœç´¢æœ€æ–°å­¦ä¹ èµ„æº<br>
                ğŸ“º æ¨èä¼˜è´¨Bç«™è§†é¢‘å’ŒUPä¸»<br>
                ğŸ“ æä¾›ä¸­æ–‡å­¦ä¹ å†…å®¹å»ºè®®<br>
                ğŸŒŸ å‘ç°çƒ­é—¨å­¦ä¹ é¢‘é“<br><br>
                è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Œæˆ‘ä¼šä¸ºæ‚¨æœç´¢æœ€åˆé€‚çš„å­¦ä¹ èµ„æºï¼`
        };
        $('#welcomeContent').html(welcomeMessages[model]);
    }

    // å¿«é€Ÿæ“ä½œæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    $('.quick-action-btn').click(function() {
        const action = $(this).data('action');
        let message = '';
        let chatType = 'general';

        switch(action) {
            case 'study_plan':
                message = selectedCourseId ?
                    `è¯·ä¸ºæˆ‘çš„è¯¾ç¨‹"${selectedCourseName}"åˆ¶å®šä¸€ä¸ªè¯¦ç»†çš„å­¦ä¹ è®¡åˆ’` :
                    'è¯·æ ¹æ®æˆ‘çš„è¯¾ç¨‹æƒ…å†µï¼Œå¸®æˆ‘åˆ¶å®šä¸€ä¸ªå­¦ä¹ è®¡åˆ’';
                chatType = 'study_plan';
                break;
            case 'progress_analysis':
                message = 'è¯·åˆ†ææˆ‘çš„å­¦ä¹ è¿›åº¦ï¼Œç»™å‡ºæ”¹è¿›å»ºè®®';
                chatType = 'progress_analysis';
                break;
            case 'study_tips':
                message = 'è¯·ç»™æˆ‘ä¸€äº›æœ‰æ•ˆçš„å­¦ä¹ æ–¹æ³•å’ŒæŠ€å·§å»ºè®®';
                break;
            case 'motivation':
                message = 'æˆ‘æœ€è¿‘å­¦ä¹ åŠ¨åŠ›ä¸è¶³ï¼Œè¯·ç»™æˆ‘ä¸€äº›æ¿€åŠ±å’Œå»ºè®®';
                break;
        }

        $('#messageInput').val(message);
        $('#chatType').val(chatType);
        $('#courseId').val(selectedCourseId);
        sendMessage();
    });

    // è¡¨å•æäº¤äº‹ä»¶
    $('#chatForm').submit(function(e) {
        e.preventDefault();
        sendMessage();
    });

    // å›è½¦å‘é€æ¶ˆæ¯
    $('#messageInput').keypress(function(e) {
        if (e.which === 13 && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // å‘é€æ¶ˆæ¯å‡½æ•°
    function sendMessage() {
        const message = $('#messageInput').val().trim();
        if (!message) return;

        const chatType = $('#chatType').val();
        const courseId = $('#courseId').val();
        const aiModel = $('#aiModel').val();

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        addMessage(message, 'user');

        // æ¸…ç©ºè¾“å…¥æ¡†
        $('#messageInput').val('');

        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        showTypingIndicator();

        // å‘é€AJAXè¯·æ±‚
        $.ajax({
            url: '{% url "ai_chat" %}',
            type: 'POST',
            data: {
                'message': message,
                'type': chatType,
                'course_id': courseId,
                'ai_model': aiModel,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                hideTypingIndicator();

                if (response.success) {
                    addMessage(response.response, 'ai');
                } else {
                    addMessage('æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ï¼š' + response.error + '(å¯èƒ½éœ€è¦æ‚¨é­”æ³•ä¸Šç½‘)', 'ai', true);
                }

                // é‡ç½®èŠå¤©ç±»å‹
                $('#chatType').val('general');
                $('#courseId').val('');
            },
            error: function() {
                hideTypingIndicator();
                addMessage('ç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åå†è¯•', 'ai', true);
            }
        });
    }

    // ç®€æ´çš„Markdownæ¸²æŸ“å‡½æ•°
    function renderMarkdown(text) {
        if (!text) return '';

        // å…ˆä¿å­˜æ‰€æœ‰é“¾æ¥ï¼Œé¿å…åç»­å¤„ç†å½±å“
        const links = [];
        text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(match, linkText, url) {
            const index = links.length;
            links.push({text: linkText, url: url});
            return `__LINK_${index}__`;
        });

        // ä¿å­˜Bç«™é“¾æ¥
        const biliLinks = [];
        text = text.replace(/(https?:\/\/(?:www\.)?bilibili\.com\/video\/[A-Za-z0-9?&=_-]+)/g, function(match, url) {
            const index = biliLinks.length;
            biliLinks.push(url);
            return `__BILI_LINK_${index}__`;
        });

        // ä¿å­˜BVå·
        const bvNumbers = [];
        text = text.replace(/\b(BV[A-Za-z0-9]{10})\b/g, function(match, bv) {
            const index = bvNumbers.length;
            bvNumbers.push(bv);
            return `__BV_NUMBER_${index}__`;
        });

        // ä¿å­˜UPä¸»æ¨è
        const upRecommendations = [];
        text = text.replace(/UPä¸»[ï¼š:]\s*([^\s\nï¼Œ,ã€‚.ï¼!ï¼Ÿ?]+)/g, function(match, upName) {
            const index = upRecommendations.length;
            upRecommendations.push(upName);
            return `__UP_RECOMMENDATION_${index}__`;
        });

        // ä¿å­˜è§†é¢‘æ¨è
        const videoRecommendations = [];
        text = text.replace(/(?:æ¨èè§†é¢‘|è§†é¢‘)[ï¼š:]\s*([^\n]+?)(?=\n|$)/g, function(match, videoTitle) {
            const index = videoRecommendations.length;
            videoRecommendations.push(videoTitle.trim());
            return `__VIDEO_RECOMMENDATION_${index}__`;
        });

        // æ¸…ç†å¤šä½™çš„æ ¼å¼ç¬¦å·å’Œemoji
        text = text.replace(/[ğŸ¯ğŸ“šğŸ’¡ğŸ”¥â­ğŸŒŸâœ¨ğŸš€ğŸ“±ğŸ’»ğŸ¨ğŸªğŸ­ğŸ¨]/g, '');

        // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
        text = text.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;');

        // å¤„ç†è¡¨æ ¼
        text = processSimpleTable(text);

        // å¤„ç†æ ‡é¢˜ (æ”¯æŒ1-6çº§æ ‡é¢˜)
        text = text.replace(/^#{6}\s+(.+)$/gm, '<h6 class="mt-2 mb-1 text-primary">$1</h6>');
        text = text.replace(/^#{5}\s+(.+)$/gm, '<h5 class="mt-2 mb-1 text-primary">$1</h5>');
        text = text.replace(/^#{4}\s+(.+)$/gm, '<h4 class="mt-2 mb-1 text-primary">$1</h4>');
        text = text.replace(/^#{3}\s+(.+)$/gm, '<h3 class="mt-3 mb-2 text-primary fw-bold">$1</h3>');
        text = text.replace(/^#{2}\s+(.+)$/gm, '<h2 class="mt-3 mb-2 text-primary fw-bold">$1</h2>');
        text = text.replace(/^#{1}\s+(.+)$/gm, '<h1 class="mt-3 mb-2 text-primary fw-bold">$1</h1>');

        // å¤„ç†æ°´å¹³åˆ†éš”çº¿
        text = text.replace(/^---+$/gm, '<hr class="my-3">');

        // å¤„ç†åˆ—è¡¨
        text = processSimpleList(text);

        // å¤„ç†ä»£ç å—
        text = text.replace(/```[\s\S]*?```/g, function(match) {
            const code = match.replace(/```/g, '').trim();
            return `<pre class="bg-dark text-light p-3 rounded mt-2 mb-2"><code>${code}</code></pre>`;
        });

        // å¤„ç†è¡Œå†…ä»£ç 
        text = text.replace(/`([^`]+)`/g, '<code class="bg-light text-danger px-2 py-1 rounded">$1</code>');

        // å¤„ç†ç²—ä½“å’Œæ–œä½“
        text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
        text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');

        // æ¢å¤æ‰€æœ‰é“¾æ¥ - ç¡®ä¿URLæ­£ç¡®
        links.forEach((link, index) => {
            // æ¸…ç†å’ŒéªŒè¯URL
            let url = link.url.trim();

            // å¤„ç†å„ç§URLæ ¼å¼
            if (url.startsWith('//')) {
                url = 'https:' + url;
            } else if (!url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('mailto:') && !url.startsWith('tel:')) {
                // å¦‚æœçœ‹èµ·æ¥åƒåŸŸåï¼Œæ·»åŠ https://
                if (url.includes('.') && !url.startsWith('/')) {
                    url = 'https://' + url;
                }
            }

            text = text.replace(`__LINK_${index}__`, `<a href="${url}" target="_blank" class="text-primary text-decoration-underline">${link.text}</a>`);
        });

        biliLinks.forEach((url, index) => {
            text = text.replace(`__BILI_LINK_${index}__`, `<a href="${url}" target="_blank" class="text-primary text-decoration-underline">è§‚çœ‹è§†é¢‘</a>`);
        });

        bvNumbers.forEach((bv, index) => {
            text = text.replace(`__BV_NUMBER_${index}__`, `<a href="https://www.bilibili.com/video/${bv}" target="_blank" class="text-primary text-decoration-underline">${bv}</a>`);
        });

        upRecommendations.forEach((upName, index) => {
            const searchUrl = `https://search.bilibili.com/upuser?keyword=${encodeURIComponent(upName)}`;
            text = text.replace(`__UP_RECOMMENDATION_${index}__`, `UPä¸»ï¼š<a href="${searchUrl}" target="_blank" class="text-primary text-decoration-underline">${upName}</a>`);
        });

        videoRecommendations.forEach((videoTitle, index) => {
            const searchUrl = `https://search.bilibili.com/all?keyword=${encodeURIComponent(videoTitle)}`;
            text = text.replace(`__VIDEO_RECOMMENDATION_${index}__`, `è§†é¢‘ï¼š<a href="${searchUrl}" target="_blank" class="text-primary text-decoration-underline">${videoTitle}</a>`);
        });

        // å¤„ç†æ®µè½å’Œæ¢è¡Œ - å‡å°‘é—´è·
        text = text.replace(/\n\s*\n/g, '</p><p class="mb-1">');
        text = text.replace(/\n/g, '<br>');

        // åŒ…è£…æ®µè½ - å‡å°‘é—´è·
        if (text && !text.match(/^<[h1-6|hr|ul|ol|table|pre]/)) {
            text = '<p class="mb-1">' + text + '</p>';
        }

        return text;
    }

    // æµ‹è¯•Markdownæ¸²æŸ“çš„å‡½æ•°
    function testMarkdownRender() {
        const testText = "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é“¾æ¥ï¼š[ç™¾åº¦](https://www.baidu.com)";
        const result = renderMarkdown(testText);
        console.log('æµ‹è¯•è¾“å…¥:', testText);
        console.log('æµ‹è¯•è¾“å‡º:', result);
        return result;
    }



    // ç®€å•çš„è¡¨æ ¼å¤„ç†å‡½æ•°
    function processSimpleTable(text) {
        const lines = text.split('\n');
        const result = [];
        let inTable = false;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();

            // æ£€æŸ¥æ˜¯å¦æ˜¯è¡¨æ ¼åˆ†éš”è¡Œ |---|---|
            if (line.match(/^\|?[\s]*:?-+:?[\s]*(\|[\s]*:?-+:?[\s]*)*\|?$/)) {
                if (i > 0 && result.length > 0) {
                    // å‰ä¸€è¡Œåº”è¯¥æ˜¯è¡¨å¤´
                    const headerLine = result.pop();
                    const headers = headerLine.split('|').map(h => h.trim()).filter(h => h);

                    let tableHtml = '<table class="table table-striped table-bordered mt-2 mb-2"><thead><tr>';
                    headers.forEach(header => {
                        tableHtml += `<th>${header}</th>`;
                    });
                    tableHtml += '</tr></thead><tbody>';

                    result.push(tableHtml);
                    inTable = true;
                }
                continue;
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯è¡¨æ ¼è¡Œ
            if (inTable && line.match(/^\|.*\|$/)) {
                const cells = line.split('|').map(c => c.trim()).filter(c => c);
                let rowHtml = '<tr>';
                cells.forEach(cell => {
                    rowHtml += `<td>${cell}</td>`;
                });
                rowHtml += '</tr>';
                result.push(rowHtml);
                continue;
            }

            // å¦‚æœä¸æ˜¯è¡¨æ ¼è¡Œä¸”ä¹‹å‰åœ¨è¡¨æ ¼ä¸­ï¼Œç»“æŸè¡¨æ ¼
            if (inTable && !line.match(/^\|.*\|$/)) {
                result.push('</tbody></table>');
                inTable = false;
            }

            result.push(lines[i]);
        }

        // å¦‚æœæœ€åè¿˜åœ¨è¡¨æ ¼ä¸­ï¼Œå…³é—­è¡¨æ ¼
        if (inTable) {
            result.push('</tbody></table>');
        }

        return result.join('\n');
    }

    // ç®€å•çš„åˆ—è¡¨å¤„ç†å‡½æ•°
    function processSimpleList(text) {
        const lines = text.split('\n');
        const result = [];
        let inList = false;
        let listType = null;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const trimmedLine = line.trim();

            // æ£€æŸ¥æ— åºåˆ—è¡¨é¡¹
            const unorderedMatch = trimmedLine.match(/^[\*\-]\s+(.+)$/);
            // æ£€æŸ¥æœ‰åºåˆ—è¡¨é¡¹
            const orderedMatch = trimmedLine.match(/^(\d+)\.\s+(.+)$/);

            if (unorderedMatch) {
                if (!inList || listType !== 'ul') {
                    if (inList) result.push(`</${listType}>`);
                    result.push('<ul class="mb-2">');
                    inList = true;
                    listType = 'ul';
                }
                result.push(`<li>${unorderedMatch[1]}</li>`);
            } else if (orderedMatch) {
                if (!inList || listType !== 'ol') {
                    if (inList) result.push(`</${listType}>`);
                    result.push('<ol class="mb-2">');
                    inList = true;
                    listType = 'ol';
                }
                result.push(`<li>${orderedMatch[2]}</li>`);
            } else {
                if (inList) {
                    result.push(`</${listType}>`);
                    inList = false;
                    listType = null;
                }
                result.push(line);
            }
        }

        if (inList) {
            result.push(`</${listType}>`);
        }

        return result.join('\n');
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
    function addMessage(text, sender, isError = false) {
        const chatMessages = $('#chatMessages');

        // å¤„ç†ç³»ç»Ÿæ¶ˆæ¯
        if (sender === 'system') {
            const systemMessageHtml = `
                <div class="message system text-center my-2">
                    <small class="badge bg-secondary">
                        <i class="fas fa-info-circle me-1"></i>${text}
                    </small>
                </div>
            `;
            chatMessages.append(systemMessageHtml);
            chatMessages.scrollTop(chatMessages[0].scrollHeight);
            return;
        }

        const messageClass = sender === 'user' ? 'user' : 'ai';
        const avatar = sender === 'user' ?
            '<div class="user-avatar">æˆ‘</div>' :
            '<div class="ai-avatar">AI</div>';

        const alignClass = sender === 'user' ? 'justify-content-end' : 'justify-content-start';
        const bubbleClass = isError ? 'bg-danger text-white' : '';

        // å¯¹AIå›å¤è¿›è¡ŒMarkdownæ¸²æŸ“
        let processedText = text;
        if (sender === 'ai' && !isError) {
            processedText = renderMarkdown(text);
        }

        const messageHtml = `
            <div class="message ${messageClass}">
                <div class="d-flex align-items-start ${alignClass}">
                    ${sender === 'ai' ? avatar : ''}
                    <div class="message-bubble ${bubbleClass}" style="${sender === 'user' ? 'white-space: pre-wrap;' : ''}">${processedText}</div>
                    ${sender === 'user' ? avatar : ''}
                </div>
            </div>
        `;

        chatMessages.append(messageHtml);
        chatMessages.scrollTop(chatMessages[0].scrollHeight);
    }

    // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
    function showTypingIndicator() {
        if (isFullscreenMode) {
            $('#typingIndicatorFullscreen').show();
            const chatMessages = $('#chatMessagesFullscreen');
            chatMessages.scrollTop(chatMessages[0].scrollHeight);
        } else {
            $('#typingIndicator').show();
            const chatMessages = $('#chatMessages');
            chatMessages.scrollTop(chatMessages[0].scrollHeight);
        }
    }

    // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
    function hideTypingIndicator() {
        if (isFullscreenMode) {
            $('#typingIndicatorFullscreen').hide();
        } else {
            $('#typingIndicator').hide();
        }
    }

    // å…¨å±å¯¹è¯åŠŸèƒ½
    $('#fullscreenChatBtn').click(function() {
        // åŒæ­¥å½“å‰å¯¹è¯å†…å®¹åˆ°å…¨å±æ¨¡å¼
        const currentMessages = $('#chatMessages').html();
        $('#chatMessagesFullscreen').html(currentMessages);

        // åŒæ­¥AIæ¨¡å‹é€‰æ‹©
        const currentModel = $('input[name="aiModel"]:checked').val();
        $(`input[name="fullscreenAiModel"][value="${currentModel}"]`).prop('checked', true);
        $('#fullscreenAiModelValue').val(currentModel);

        // åŒæ­¥é€‰ä¸­çš„è¯¾ç¨‹ä¿¡æ¯åˆ°å…¨å±æ¨¡å¼
        $('#fullscreenCourseId').val(selectedCourseId);

        // æ˜¾ç¤ºå…¨å±æ¨¡æ€æ¡†
        $('#fullscreenChatModal').modal('show');

        // æ»šåŠ¨åˆ°åº•éƒ¨
        setTimeout(function() {
            const fullscreenMessages = $('#chatMessagesFullscreen');
            fullscreenMessages.scrollTop(fullscreenMessages[0].scrollHeight);
        }, 300);
    });

    // å…¨å±æ¨¡å¼ä¸‹çš„AIæ¨¡å‹åˆ‡æ¢
    $('input[name="fullscreenAiModel"]').change(function() {
        const selectedModel = $(this).val();
        $('#fullscreenAiModelValue').val(selectedModel);

        // åŒæ­¥åˆ°ä¸»ç•Œé¢
        $(`input[name="aiModel"][value="${selectedModel}"]`).prop('checked', true);
        $('#aiModel').val(selectedModel);

        // æ›´æ–°ä¸»ç•Œé¢çš„æ¬¢è¿æ¶ˆæ¯
        updateWelcomeMessage(selectedModel);

        // æ·»åŠ æ¨¡å‹åˆ‡æ¢æç¤ºåˆ°å…¨å±æ¨¡å¼
        const modelNames = {
            'gemini': 'Google Gemini',
            'deepseek': 'DeepSeek'
        };
        addMessageFullscreen(`å·²åˆ‡æ¢åˆ° ${modelNames[selectedModel]} æ¨¡å‹`, 'system');
    });

    // å…¨å±æ¨¡å¼è¡¨å•æäº¤
    $('#fullscreenChatForm').submit(function(e) {
        e.preventDefault();
        sendMessageFullscreen();
    });

    // å…¨å±æ¨¡å¼å›è½¦å‘é€
    $('#fullscreenMessageInput').keypress(function(e) {
        if (e.which === 13 && !e.shiftKey) {
            e.preventDefault();
            sendMessageFullscreen();
        }
    });

    // å…¨å±æ¨¡å¼å¿«é€Ÿæ“ä½œæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    $('.fullscreen-quick-action-btn').click(function() {
        const action = $(this).data('action');
        let message = '';
        let chatType = 'general';

        switch(action) {
            case 'study_plan':
                message = selectedCourseId ?
                    `è¯·ä¸ºæˆ‘çš„è¯¾ç¨‹"${selectedCourseName}"åˆ¶å®šä¸€ä¸ªè¯¦ç»†çš„å­¦ä¹ è®¡åˆ’` :
                    'è¯·æ ¹æ®æˆ‘çš„è¯¾ç¨‹æƒ…å†µï¼Œå¸®æˆ‘åˆ¶å®šä¸€ä¸ªå­¦ä¹ è®¡åˆ’';
                chatType = 'study_plan';
                break;
            case 'progress_analysis':
                message = 'è¯·åˆ†ææˆ‘çš„å­¦ä¹ è¿›åº¦ï¼Œç»™å‡ºæ”¹è¿›å»ºè®®';
                chatType = 'progress_analysis';
                break;
            case 'study_tips':
                message = 'è¯·ç»™æˆ‘ä¸€äº›æœ‰æ•ˆçš„å­¦ä¹ æ–¹æ³•å’ŒæŠ€å·§å»ºè®®';
                break;
            case 'motivation':
                message = 'æˆ‘æœ€è¿‘å­¦ä¹ åŠ¨åŠ›ä¸è¶³ï¼Œè¯·ç»™æˆ‘ä¸€äº›æ¿€åŠ±å’Œå»ºè®®';
                break;
        }

        $('#fullscreenMessageInput').val(message);
        $('#fullscreenChatType').val(chatType);
        $('#fullscreenCourseId').val(selectedCourseId);
        sendMessageFullscreen();
    });

    // å…¨å±æ¨¡å¼å‘é€æ¶ˆæ¯å‡½æ•°
    function sendMessageFullscreen() {
        const message = $('#fullscreenMessageInput').val().trim();
        if (!message) return;

        const chatType = $('#fullscreenChatType').val();
        const courseId = $('#fullscreenCourseId').val();
        const aiModel = $('#fullscreenAiModelValue').val();

        // è®¾ç½®å…¨å±æ¨¡å¼æ ‡å¿—
        isFullscreenMode = true;

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å…¨å±èŠå¤©ç•Œé¢
        addMessageFullscreen(message, 'user');

        // æ¸…ç©ºè¾“å…¥æ¡†
        $('#fullscreenMessageInput').val('');

        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        showTypingIndicator();

        // å‘é€AJAXè¯·æ±‚
        $.ajax({
            url: '{% url "ai_chat" %}',
            type: 'POST',
            data: {
                'message': message,
                'type': chatType,
                'course_id': courseId,
                'ai_model': aiModel,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                hideTypingIndicator();

                if (response.success) {
                    addMessageFullscreen(response.response, 'ai');
                } else {
                    addMessageFullscreen('æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ï¼š' + response.error + '(å¯èƒ½éœ€è¦æ‚¨é­”æ³•ä¸Šç½‘)', 'ai', true);
                }

                // é‡ç½®èŠå¤©ç±»å‹
                $('#fullscreenChatType').val('general');
                $('#fullscreenCourseId').val('');
            },
            error: function() {
                hideTypingIndicator();
                addMessageFullscreen('ç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åå†è¯•', 'ai', true);
            },
            complete: function() {
                // é‡ç½®å…¨å±æ¨¡å¼æ ‡å¿—
                isFullscreenMode = false;
            }
        });
    }

    // å…¨å±æ¨¡å¼æ·»åŠ æ¶ˆæ¯å‡½æ•°
    function addMessageFullscreen(text, sender, isError = false) {
        const chatMessages = $('#chatMessagesFullscreen');

        // å¤„ç†ç³»ç»Ÿæ¶ˆæ¯
        if (sender === 'system') {
            const systemMessageHtml = `
                <div class="message system text-center my-2">
                    <small class="badge bg-secondary">
                        <i class="fas fa-info-circle me-1"></i>${text}
                    </small>
                </div>
            `;
            chatMessages.append(systemMessageHtml);
            chatMessages.scrollTop(chatMessages[0].scrollHeight);
            return;
        }

        const messageClass = sender === 'user' ? 'user' : 'ai';
        const avatar = sender === 'user' ?
            '<div class="user-avatar">æˆ‘</div>' :
            '<div class="ai-avatar">AI</div>';

        const alignClass = sender === 'user' ? 'justify-content-end' : '';
        const bubbleClass = sender === 'user' ? 'user-bubble' : (isError ? 'ai-bubble-error' : 'ai-bubble');

        // å¤„ç†AIæ¶ˆæ¯çš„Markdownæ¸²æŸ“
        const processedText = sender === 'ai' ? renderMarkdown(text) : text;

        const messageHtml = `
            <div class="message ${messageClass}">
                <div class="d-flex align-items-start ${alignClass}">
                    ${sender === 'ai' ? avatar : ''}
                    <div class="message-bubble ${bubbleClass}" style="${sender === 'user' ? 'white-space: pre-wrap;' : ''}">${processedText}</div>
                    ${sender === 'user' ? avatar : ''}
                </div>
            </div>
        `;

        chatMessages.append(messageHtml);
        chatMessages.scrollTop(chatMessages[0].scrollHeight);

        // åŒæ­¥åˆ°ä¸»ç•Œé¢
        addMessage(text, sender, isError);
    }

    // æ¨¡æ€æ¡†å…³é—­æ—¶åŒæ­¥æ¶ˆæ¯åˆ°ä¸»ç•Œé¢
    $('#fullscreenChatModal').on('hidden.bs.modal', function() {
        const fullscreenMessages = $('#chatMessagesFullscreen').html();
        $('#chatMessages').html(fullscreenMessages);

        // æ»šåŠ¨åˆ°åº•éƒ¨
        const chatMessages = $('#chatMessages');
        chatMessages.scrollTop(chatMessages[0].scrollHeight);
    });
});

// é€‰æ‹©è¯¾ç¨‹å‡½æ•°
function selectCourse(courseId, courseName) {
    // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
    $('.course-card').removeClass('border-primary bg-light');

    // æ·»åŠ é€‰ä¸­çŠ¶æ€
    $(`[data-course-id="${courseId}"]`).addClass('border-primary bg-light');

    // æ›´æ–°å…¨å±€å˜é‡
    window.selectedCourseId = courseId;
    window.selectedCourseName = courseName;

    // æ›´æ–°éšè—å­—æ®µ
    $('#courseId').val(courseId);

    // æ˜¾ç¤ºé€‰ä¸­æç¤º
    const chatMessages = $('#chatMessages');
    const messageHtml = `
        <div class="message ai">
            <div class="d-flex align-items-start">
                <div class="ai-avatar">AI</div>
                <div class="message-bubble bg-info text-white">
                    å·²é€‰æ‹©è¯¾ç¨‹ï¼š${courseName}<br>
                    ç°åœ¨æˆ‘å¯ä»¥ä¸ºè¿™é—¨è¯¾ç¨‹æä¾›æ›´ç²¾å‡†çš„å­¦ä¹ å»ºè®®äº†ï¼
                </div>
            </div>
        </div>
    `;
    chatMessages.append(messageHtml);
    chatMessages.scrollTop(chatMessages[0].scrollHeight);
}
</script>
{% endblock %}
